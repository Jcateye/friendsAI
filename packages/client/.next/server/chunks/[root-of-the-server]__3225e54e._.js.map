{"version":3,"sources":["../../../../../../../OnePersonCompany/friendsAI/packages/client/app/api/feishu/bitable/logic.ts"],"sourcesContent":["export interface BitableSyncRequest {\n  contactId: string;\n  contactName: string;\n  messageId: string;\n  role: 'user' | 'assistant';\n  content: string;\n  occurredAt: string;\n  source: string;\n  extractedFields?: Record<string, string>;\n}\n\ninterface TenantTokenResponse {\n  code?: number;\n  msg?: string;\n  tenant_access_token?: string;\n}\n\ninterface BitableCreateRecordResponse {\n  code?: number;\n  msg?: string;\n  data?: {\n    record?: {\n      record_id?: string;\n    };\n  };\n}\n\nexport class ValidationError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = 'ValidationError';\n  }\n}\n\ninterface FeishuAuthConfig {\n  appId: string;\n  appSecret: string;\n  baseUrl: string;\n}\n\ninterface FeishuBitableConfig extends FeishuAuthConfig {\n  appToken: string;\n  tableId: string;\n}\n\nexport function parseBitableSyncRequestBody(input: unknown): BitableSyncRequest {\n  if (!input || typeof input !== 'object') {\n    throw new ValidationError('请求体必须是对象');\n  }\n\n  const body = input as Partial<BitableSyncRequest>;\n\n  if (\n    typeof body.contactId !== 'string' ||\n    typeof body.contactName !== 'string' ||\n    typeof body.messageId !== 'string' ||\n    typeof body.role !== 'string' ||\n    typeof body.content !== 'string' ||\n    typeof body.occurredAt !== 'string' ||\n    typeof body.source !== 'string'\n  ) {\n    throw new ValidationError('请求字段格式无效');\n  }\n\n  const contactId = body.contactId.trim();\n  const contactName = body.contactName.trim();\n  const messageId = body.messageId.trim();\n  const role = body.role.trim();\n  const content = body.content.trim();\n  const occurredAt = body.occurredAt.trim();\n  const source = body.source.trim();\n\n  if (!contactId || contactId.length > 64) {\n    throw new ValidationError('contactId 超出限制');\n  }\n\n  if (!contactName || contactName.length > 80) {\n    throw new ValidationError('contactName 超出限制');\n  }\n\n  if (!messageId || messageId.length > 64) {\n    throw new ValidationError('messageId 超出限制');\n  }\n\n  if (role !== 'user' && role !== 'assistant') {\n    throw new ValidationError('role 无效');\n  }\n\n  if (!content || content.length > 4000) {\n    throw new ValidationError('content 超出限制');\n  }\n\n  if (source !== 'chat') {\n    throw new ValidationError('source 无效');\n  }\n\n  const timestamp = Date.parse(occurredAt);\n  if (Number.isNaN(timestamp)) {\n    throw new ValidationError('occurredAt 时间格式无效');\n  }\n\n  const extractedFieldsInput = body.extractedFields;\n  if (extractedFieldsInput !== undefined) {\n    if (!extractedFieldsInput || typeof extractedFieldsInput !== 'object' || Array.isArray(extractedFieldsInput)) {\n      throw new ValidationError('extractedFields 格式无效');\n    }\n\n    const entries = Object.entries(extractedFieldsInput);\n    if (entries.length > 50) {\n      throw new ValidationError('extractedFields 条目过多');\n    }\n\n    for (const [key, value] of entries) {\n      if (typeof value !== 'string') {\n        throw new ValidationError('extractedFields 的值必须是字符串');\n      }\n\n      if (!key.trim() || key.trim().length > 64) {\n        throw new ValidationError('extractedFields 的键超出限制');\n      }\n\n      if (value.trim().length > 512) {\n        throw new ValidationError('extractedFields 的值超出限制');\n      }\n    }\n  }\n\n  return {\n    contactId,\n    contactName,\n    messageId,\n    role,\n    content,\n    occurredAt: new Date(timestamp).toISOString(),\n    source,\n    extractedFields:\n      extractedFieldsInput === undefined\n        ? undefined\n        : Object.fromEntries(\n            Object.entries(extractedFieldsInput).map(([key, value]) => [key.trim(), (value as string).trim()])\n          ),\n  };\n}\n\nexport function buildBitableRecordFields(payload: BitableSyncRequest): Record<string, string> {\n  return {\n    'Contact ID': payload.contactId,\n    'Contact Name': payload.contactName,\n    'Message ID': payload.messageId,\n    Role: payload.role,\n    Content: payload.content,\n    Source: payload.source,\n    'Occurred At': payload.occurredAt,\n    ...(payload.extractedFields ?? {}),\n  };\n}\n\nexport async function requestTenantAccessToken(\n  config: FeishuAuthConfig,\n  requestFn: typeof fetch = fetch\n): Promise<string> {\n  const response = await requestFn(`${config.baseUrl}/open-apis/auth/v3/tenant_access_token/internal`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      app_id: config.appId,\n      app_secret: config.appSecret,\n    }),\n    signal: AbortSignal.timeout(10000),\n  });\n\n  if (!response.ok) {\n    throw new Error('获取飞书租户令牌失败');\n  }\n\n  const data = (await response.json()) as TenantTokenResponse;\n\n  if (data.code !== 0 || !data.tenant_access_token) {\n    throw new Error('获取飞书租户令牌失败');\n  }\n\n  return data.tenant_access_token;\n}\n\nexport async function syncMessageToBitable(\n  input: {\n    payload: BitableSyncRequest;\n    config: FeishuBitableConfig;\n  },\n  requestFn: typeof fetch = fetch\n): Promise<{ recordId: string }> {\n  const token = await requestTenantAccessToken(input.config, requestFn);\n\n  const response = await requestFn(\n    `${input.config.baseUrl}/open-apis/bitable/v1/apps/${input.config.appToken}/tables/${input.config.tableId}/records`,\n    {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${token}`,\n      },\n      body: JSON.stringify({\n        fields: buildBitableRecordFields(input.payload),\n      }),\n      signal: AbortSignal.timeout(10000),\n    }\n  );\n\n  if (!response.ok) {\n    throw new Error('写入飞书多维表失败');\n  }\n\n  const data = (await response.json()) as BitableCreateRecordResponse;\n  const recordId = data.data?.record?.record_id;\n\n  if (data.code !== 0 || !recordId) {\n    throw new Error('写入飞书多维表失败');\n  }\n\n  return { recordId };\n}\n"],"names":[],"mappings":"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"}
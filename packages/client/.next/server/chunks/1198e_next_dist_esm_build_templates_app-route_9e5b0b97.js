module.exports=[38166,e=>{"use strict";var t=e.i(87665),n=e.i(47008),a=e.i(37676),r=e.i(14447),o=e.i(37716),s=e.i(92325),i=e.i(77709),l=e.i(52204),c=e.i(38521),u=e.i(96948),d=e.i(64238),p=e.i(20220),h=e.i(50537),f=e.i(28305),m=e.i(33644),g=e.i(93695);e.i(61785);var w=e.i(7838),v=e.i(12826);class R extends Error{constructor(e){super(e),this.name="ValidationError"}}let y=["extract_contact_info"];function A(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}function E(e,t){if(void 0===e)return"enabled"===t?[...y]:[];if(!Array.isArray(e))throw new R(`tools.${t} 必须是数组`);return Array.from(new Set(e.map(e=>{if("extract_contact_info"!==e&&"feishu_template_message"!==e)throw new R(`tools.${t} 包含不支持的工具`);return e})))}function _(e,t){let n=e.tools?.enabled??y;return!(e.tools?.disabled??[]).includes(t)&&n.includes(t)}var T=e.i(55561);let b=process.env.LOCAL_AI_BASE_URL??"http://127.0.0.1:9739/v1",I=process.env.LOCAL_AI_MODEL??"gemini-3-flash",C=process.env.LOCAL_AI_API_KEY??"",x="true"===process.env.FEISHU_SYNC_ENABLED,S="true"===process.env.FEISHU_CHAT_TOOL_ENABLED,O=process.env.FEISHU_BASE_URL??"https://open.feishu.cn",N=process.env.FEISHU_APP_ID??"",P=process.env.FEISHU_APP_SECRET??"",M=process.env.FEISHU_BITABLE_APP_TOKEN??"",U=process.env.FEISHU_BITABLE_TABLE_ID??"";async function H(e){try{var t;let n;if(!C)return v.NextResponse.json({error:"本地 AI 服务未配置密钥"},{status:500});let a=await e.json(),r=function(e){if(!e||"object"!=typeof e)throw new R("请求体必须是对象");if(!e.contact||"object"!=typeof e.contact)throw new R("缺少联系人信息");if("string"!=typeof e.contact.id||"string"!=typeof e.contact.name)throw new R("联系人信息格式无效");let t=e.contact.id.trim(),n=e.contact.name.trim();if(!t||t.length>64||!n||n.length>80)throw new R("联系人信息超出限制");if(!Array.isArray(e.messages)||0===e.messages.length)throw new R("消息列表不能为空");if(e.messages.length>50)throw new R("消息条数超出限制");let a=e.messages.filter(e=>!!e&&"object"==typeof e&&("user"===e.role||"assistant"===e.role)&&"string"==typeof e.content).map(e=>({role:e.role,content:e.content.trim()}));if(0===a.length)throw new R("消息列表格式无效");if(a.some(e=>0===e.content.length||e.content.length>4e3))throw new R("消息内容超出限制");return{contact:{id:t,name:n},messages:a,tools:function(e){if(void 0===e)return{enabled:[...y],disabled:[]};if(!A(e))throw new R("tools 格式无效");let t=E(e.enabled,"enabled"),n=E(e.disabled,"disabled"),a=e.feishuTemplateMessage;if(void 0===a)return{enabled:t,disabled:n};if(!A(a))throw new R("tools.feishuTemplateMessage 格式无效");let r=a.templateId;if(void 0!==r&&"string"!=typeof r)throw new R("tools.feishuTemplateMessage.templateId 必须是字符串");let o=r?.trim();if(o&&o.length>128)throw new R("tools.feishuTemplateMessage.templateId 超出限制");let s=a.mode;if(void 0!==s&&"sync"!==s&&"preview"!==s)throw new R("tools.feishuTemplateMessage.mode 无效");let i=a.variables;if(void 0!==i&&!A(i))throw new R("tools.feishuTemplateMessage.variables 必须是对象");let l=Object.entries(i??{});if(l.length>50)throw new R("tools.feishuTemplateMessage.variables 条目过多");let c=l.reduce((e,[t,n])=>{if("string"!=typeof n)throw new R("tools.feishuTemplateMessage.variables 的值必须是字符串");let a=t.trim(),r=n.trim();if(!a||a.length>64)throw new R("tools.feishuTemplateMessage.variables 的键超出限制");if(r.length>512)throw new R("tools.feishuTemplateMessage.variables 的值超出限制");return{...e,[a]:r}},{});return{enabled:t,disabled:n,feishuTemplateMessage:{templateId:o,variables:Object.keys(c).length>0?c:void 0,mode:s??"sync"}}}(e.tools)}}(a),o={model:I,temperature:.4,messages:[{role:"system",content:"你是朋友关系管理助手。请用简洁中文回复，并尽量提取用户对话里的联系人信息（如邮箱、手机号、公司、职位、标签）。"},...r.messages.map(e=>({role:"assistant"===e.role?"assistant":"user",content:e.content}))]},s=await fetch(`${b}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${C}`},body:JSON.stringify(o),signal:AbortSignal.timeout(15e3)});if(!s.ok)return v.NextResponse.json({error:"本地 AI 代理请求失败"},{status:502});let i=(t=await s.json(),(n=t.choices?.[0]?.message?.content)&&"string"==typeof n&&n.trim()||"我已经记下来了。"),l=[...r.messages].reverse().find(e=>"user"===e.role),c=`source-${Date.now()}`,u=_(r,"extract_contact_info"),d=S&&_(r,"feishu_template_message"),p=r.tools?.feishuTemplateMessage?.mode??"sync",h=l?function(e,t,n){let a=e.trim();if(!a)return null;let r=a.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i),o=a.match(/(?:\+?86[-\s]?)?1[3-9]\d{9}/),s=a.match(/(工程师|产品经理|设计师|销售|运营|创始人|教师|医生)/),i=a.match(/(?:在|就职于|任职于)([^，。\s]{2,20})(?:工作|任职|上班)?/),l=[];return(a.includes("React")&&l.push("React"),a.includes("AI")&&l.push("AI"),a.includes("创业")&&l.push("创业"),r||o||s||i||l.length>0)?{id:`${n}-card`,name:t,email:r?.[0],phone:o?.[0],company:i?.[1],title:s?.[0],tags:l,notes:"由 AI 对话自动提取",createdAt:new Date,sourceMessageId:n}:null}(l.content,r.contact.name,c):null,f=u?h??void 0:void 0,m=u?function(e){if(!e)return;let t=[];if(e.name&&t.push(e.name),e.email&&t.push(`邮箱 ${e.email}`),e.phone&&t.push(`手机号 ${e.phone}`),e.company&&t.push(`公司 ${e.company}`),e.title&&t.push(`职位 ${e.title}`),0!==t.length)return`已提取联系人信息：${t.join("，")}`}(h):void 0,g=h?{...h.email?{Email:h.email}:{},...h.phone?{Phone:h.phone}:{},...h.company?{Company:h.company}:{},...h.title?{Title:h.title}:{},...h.tags&&h.tags.length>0?{Tags:h.tags.join(", ")}:{}}:void 0;if(d&&"sync"===p&&x&&N&&P&&M&&U&&l&&"user"===l.role)try{let e=(0,T.parseBitableSyncRequestBody)({contactId:r.contact.id,contactName:r.contact.name,messageId:c,role:"user",content:l.content,occurredAt:new Date().toISOString(),source:"chat",extractedFields:g});await (0,T.syncMessageToBitable)({payload:e,config:{baseUrl:O,appId:N,appSecret:P,appToken:M,tableId:U}})}catch(e){console.error("Feishu sync failed",{contactId:r.contact.id,messageId:c,error:e instanceof Error?e.message:String(e)})}return v.NextResponse.json({reply:i,toolResult:m,contactCard:f})}catch(e){if(e instanceof R)return v.NextResponse.json({error:e.message},{status:400});return v.NextResponse.json({error:"请求处理失败"},{status:500})}}e.s(["POST",()=>H],89194);var j=e.i(89194);let D=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OnePersonCompany/friendsAI/packages/client/app/api/chat/route.ts",nextConfigOutput:"",userland:j}),{workAsyncStorage:L,workUnitAsyncStorage:$,serverHooks:B}=D;function k(){return(0,a.patchFetch)({workAsyncStorage:L,workUnitAsyncStorage:$})}async function F(e,t,a){D.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/chat/route";v=v.replace(/\/index$/,"")||"/";let R=await D.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:A,nextConfig:E,parsedUrl:_,isDraftMode:T,prerenderManifest:b,routerServerContext:I,isOnDemandRevalidate:C,revalidateOnlyGenerated:x,resolvedPathname:S,clientReferenceManifest:O,serverActionsManifest:N}=R,P=(0,i.normalizeAppPath)(v),M=!!(b.dynamicRoutes[P]||b.routes[S]),U=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,_,!1):t.end("This page could not be found"),null);if(M&&!T){let e=!!b.routes[S],t=b.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await U();throw new g.NoFallbackError}}let H=null;!M||D.isDev||T||(H="/index"===(H=S)?"/":H);let j=!0===D.isDev||!M,L=M&&!j;N&&O&&(0,s.setManifestsSingleton)({page:v,clientReferenceManifest:O,serverActionsManifest:N});let $=e.method||"GET",B=(0,o.getTracer)(),k=B.getActiveScopeSpan(),F={params:A,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a,r)=>D.onRequestError(e,t,a,r,I)},sharedContext:{buildId:y}},q=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),V=c.NextRequestAdapter.fromNodeNextRequest(q,(0,c.signalFromNodeResponse)(t));try{let s=async e=>D.handle(V,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=B.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${$} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${v}`)}),i=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var o,l;let c=async({previousCacheEntry:n})=>{try{if(!i&&C&&x&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await s(r);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=F.renderOpts.collectedTags;if(!M)return await (0,p.sendResponse)(q,K,o,F.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[m.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:C})},!1,I),t}},u=await D.handleResponse({req:e,nextConfig:E,cacheKey:H,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:x,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:i});if(!M)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&M||g.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(q,K,new Response(u.value.body,{headers:g,status:u.value.status||200})),null};k?await l(k):await B.withPropagatedContext(e.headers,()=>B.trace(u.BaseServerSpan.handleRequest,{spanName:`${$} ${v}`,kind:o.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:C})},!1,I),M)throw t;return await (0,p.sendResponse)(q,K,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>k,"routeModule",()=>D,"serverHooks",()=>B,"workAsyncStorage",()=>L,"workUnitAsyncStorage",()=>$],38166)}];

//# sourceMappingURL=1198e_next_dist_esm_build_templates_app-route_9e5b0b97.js.map
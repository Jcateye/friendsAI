{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/haoqi/OnePersonCompany/friendsAI/packages/client/app/api/chat/logic.ts"],"sourcesContent":["import type { ContactCard } from '@/types';\n\ninterface ProxyMessage {\n  role: 'system' | 'user' | 'assistant';\n  content: string;\n}\n\ninterface ProxyResponse {\n  choices?: Array<{\n    message?: {\n      content?: string;\n    };\n  }>;\n}\n\nexport interface ChatRequestInput {\n  contact: {\n    id: string;\n    name: string;\n  };\n  messages: Array<{\n    role: 'user' | 'assistant';\n    content: string;\n  }>;\n}\n\nexport class ValidationError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = 'ValidationError';\n  }\n}\n\nexport interface ChatApiPayload {\n  model: string;\n  messages: ProxyMessage[];\n  temperature: number;\n}\n\nexport function parseChatRequestBody(input: unknown): ChatRequestInput {\n  if (!input || typeof input !== 'object') {\n    throw new ValidationError('请求体必须是对象');\n  }\n\n  const body = input as Partial<ChatRequestInput>;\n\n  if (!body.contact || typeof body.contact !== 'object') {\n    throw new ValidationError('缺少联系人信息');\n  }\n\n  if (typeof body.contact.id !== 'string' || typeof body.contact.name !== 'string') {\n    throw new ValidationError('联系人信息格式无效');\n  }\n\n  const contactId = body.contact.id.trim();\n  const contactName = body.contact.name.trim();\n\n  if (!contactId || contactId.length > 64 || !contactName || contactName.length > 80) {\n    throw new ValidationError('联系人信息超出限制');\n  }\n\n  if (!Array.isArray(body.messages) || body.messages.length === 0) {\n    throw new ValidationError('消息列表不能为空');\n  }\n\n  if (body.messages.length > 50) {\n    throw new ValidationError('消息条数超出限制');\n  }\n\n  const normalizedMessages = body.messages\n    .filter((message): message is { role: 'user' | 'assistant'; content: string } => {\n      if (!message || typeof message !== 'object') {\n        return false;\n      }\n\n      if (message.role !== 'user' && message.role !== 'assistant') {\n        return false;\n      }\n\n      return typeof message.content === 'string';\n    })\n    .map((message) => ({\n      role: message.role,\n      content: message.content.trim(),\n    }));\n\n  if (normalizedMessages.length === 0) {\n    throw new ValidationError('消息列表格式无效');\n  }\n\n  if (normalizedMessages.some((message) => message.content.length === 0 || message.content.length > 4000)) {\n    throw new ValidationError('消息内容超出限制');\n  }\n\n  return {\n    contact: {\n      id: contactId,\n      name: contactName,\n    },\n    messages: normalizedMessages,\n  };\n}\n\nexport function buildProxyPayload(request: ChatRequestInput, model: string): ChatApiPayload {\n  const systemPrompt =\n    '你是朋友关系管理助手。请用简洁中文回复，并尽量提取用户对话里的联系人信息（如邮箱、手机号、公司、职位、标签）。';\n\n  const mappedMessages: ProxyMessage[] = request.messages.map((message) => {\n    const role = message.role === 'assistant' ? 'assistant' : 'user';\n    return {\n      role,\n      content: message.content,\n    };\n  });\n\n  return {\n    model,\n    temperature: 0.4,\n    messages: [\n      {\n        role: 'system',\n        content: systemPrompt,\n      },\n      ...mappedMessages,\n    ],\n  };\n}\n\nexport function extractAssistantReply(proxyResponse: ProxyResponse): string {\n  const content = proxyResponse.choices?.[0]?.message?.content;\n\n  if (!content || typeof content !== 'string') {\n    return '我已经记下来了。';\n  }\n\n  const normalized = content.trim();\n  return normalized || '我已经记下来了。';\n}\n\nexport function extractContactCardFromText(\n  text: string,\n  contactName: string,\n  sourceMessageId: string\n): ContactCard | null {\n  const normalized = text.trim();\n\n  if (!normalized) {\n    return null;\n  }\n\n  const emailMatch = normalized.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}/i);\n  const phoneMatch = normalized.match(/(?:\\+?86[-\\s]?)?1[3-9]\\d{9}/);\n  const titleMatch = normalized.match(/(工程师|产品经理|设计师|销售|运营|创始人|教师|医生)/);\n  const companyMatch = normalized.match(/(?:在|就职于|任职于)([^，。\\s]{2,20})(?:工作|任职|上班)?/);\n\n  const tags: string[] = [];\n  if (normalized.includes('React')) tags.push('React');\n  if (normalized.includes('AI')) tags.push('AI');\n  if (normalized.includes('创业')) tags.push('创业');\n\n  const hasAnyField = Boolean(emailMatch || phoneMatch || titleMatch || companyMatch || tags.length > 0);\n\n  if (!hasAnyField) {\n    return null;\n  }\n\n  return {\n    id: `${sourceMessageId}-card`,\n    name: contactName,\n    email: emailMatch?.[0],\n    phone: phoneMatch?.[0],\n    company: companyMatch?.[1],\n    title: titleMatch?.[0],\n    tags,\n    notes: '由 AI 对话自动提取',\n    createdAt: new Date(),\n    sourceMessageId,\n  };\n}\n\nexport function buildToolResult(card: ContactCard | null): string | undefined {\n  if (!card) {\n    return undefined;\n  }\n\n  const fields: string[] = [];\n\n  if (card.name) fields.push(card.name);\n  if (card.email) fields.push(`邮箱 ${card.email}`);\n  if (card.phone) fields.push(`手机号 ${card.phone}`);\n  if (card.company) fields.push(`公司 ${card.company}`);\n  if (card.title) fields.push(`职位 ${card.title}`);\n\n  if (fields.length === 0) {\n    return undefined;\n  }\n\n  return `已提取联系人信息：${fields.join('，')}`;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AA0BO,MAAM,wBAAwB;IACnC,YAAY,OAAe,CAAE;QAC3B,KAAK,CAAC;QACN,IAAI,CAAC,IAAI,GAAG;IACd;AACF;AAQO,SAAS,qBAAqB,KAAc;IACjD,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;QACvC,MAAM,IAAI,gBAAgB;IAC5B;IAEA,MAAM,OAAO;IAEb,IAAI,CAAC,KAAK,OAAO,IAAI,OAAO,KAAK,OAAO,KAAK,UAAU;QACrD,MAAM,IAAI,gBAAgB;IAC5B;IAEA,IAAI,OAAO,KAAK,OAAO,CAAC,EAAE,KAAK,YAAY,OAAO,KAAK,OAAO,CAAC,IAAI,KAAK,UAAU;QAChF,MAAM,IAAI,gBAAgB;IAC5B;IAEA,MAAM,YAAY,KAAK,OAAO,CAAC,EAAE,CAAC,IAAI;IACtC,MAAM,cAAc,KAAK,OAAO,CAAC,IAAI,CAAC,IAAI;IAE1C,IAAI,CAAC,aAAa,UAAU,MAAM,GAAG,MAAM,CAAC,eAAe,YAAY,MAAM,GAAG,IAAI;QAClF,MAAM,IAAI,gBAAgB;IAC5B;IAEA,IAAI,CAAC,MAAM,OAAO,CAAC,KAAK,QAAQ,KAAK,KAAK,QAAQ,CAAC,MAAM,KAAK,GAAG;QAC/D,MAAM,IAAI,gBAAgB;IAC5B;IAEA,IAAI,KAAK,QAAQ,CAAC,MAAM,GAAG,IAAI;QAC7B,MAAM,IAAI,gBAAgB;IAC5B;IAEA,MAAM,qBAAqB,KAAK,QAAQ,CACrC,MAAM,CAAC,CAAC;QACP,IAAI,CAAC,WAAW,OAAO,YAAY,UAAU;YAC3C,OAAO;QACT;QAEA,IAAI,QAAQ,IAAI,KAAK,UAAU,QAAQ,IAAI,KAAK,aAAa;YAC3D,OAAO;QACT;QAEA,OAAO,OAAO,QAAQ,OAAO,KAAK;IACpC,GACC,GAAG,CAAC,CAAC,UAAY,CAAC;YACjB,MAAM,QAAQ,IAAI;YAClB,SAAS,QAAQ,OAAO,CAAC,IAAI;QAC/B,CAAC;IAEH,IAAI,mBAAmB,MAAM,KAAK,GAAG;QACnC,MAAM,IAAI,gBAAgB;IAC5B;IAEA,IAAI,mBAAmB,IAAI,CAAC,CAAC,UAAY,QAAQ,OAAO,CAAC,MAAM,KAAK,KAAK,QAAQ,OAAO,CAAC,MAAM,GAAG,OAAO;QACvG,MAAM,IAAI,gBAAgB;IAC5B;IAEA,OAAO;QACL,SAAS;YACP,IAAI;YACJ,MAAM;QACR;QACA,UAAU;IACZ;AACF;AAEO,SAAS,kBAAkB,OAAyB,EAAE,KAAa;IACxE,MAAM,eACJ;IAEF,MAAM,iBAAiC,QAAQ,QAAQ,CAAC,GAAG,CAAC,CAAC;QAC3D,MAAM,OAAO,QAAQ,IAAI,KAAK,cAAc,cAAc;QAC1D,OAAO;YACL;YACA,SAAS,QAAQ,OAAO;QAC1B;IACF;IAEA,OAAO;QACL;QACA,aAAa;QACb,UAAU;YACR;gBACE,MAAM;gBACN,SAAS;YACX;eACG;SACJ;IACH;AACF;AAEO,SAAS,sBAAsB,aAA4B;IAChE,MAAM,UAAU,cAAc,OAAO,EAAE,CAAC,EAAE,EAAE,SAAS;IAErD,IAAI,CAAC,WAAW,OAAO,YAAY,UAAU;QAC3C,OAAO;IACT;IAEA,MAAM,aAAa,QAAQ,IAAI;IAC/B,OAAO,cAAc;AACvB;AAEO,SAAS,2BACd,IAAY,EACZ,WAAmB,EACnB,eAAuB;IAEvB,MAAM,aAAa,KAAK,IAAI;IAE5B,IAAI,CAAC,YAAY;QACf,OAAO;IACT;IAEA,MAAM,aAAa,WAAW,KAAK,CAAC;IACpC,MAAM,aAAa,WAAW,KAAK,CAAC;IACpC,MAAM,aAAa,WAAW,KAAK,CAAC;IACpC,MAAM,eAAe,WAAW,KAAK,CAAC;IAEtC,MAAM,OAAiB,EAAE;IACzB,IAAI,WAAW,QAAQ,CAAC,UAAU,KAAK,IAAI,CAAC;IAC5C,IAAI,WAAW,QAAQ,CAAC,OAAO,KAAK,IAAI,CAAC;IACzC,IAAI,WAAW,QAAQ,CAAC,OAAO,KAAK,IAAI,CAAC;IAEzC,MAAM,cAAc,QAAQ,cAAc,cAAc,cAAc,gBAAgB,KAAK,MAAM,GAAG;IAEpG,IAAI,CAAC,aAAa;QAChB,OAAO;IACT;IAEA,OAAO;QACL,IAAI,GAAG,gBAAgB,KAAK,CAAC;QAC7B,MAAM;QACN,OAAO,YAAY,CAAC,EAAE;QACtB,OAAO,YAAY,CAAC,EAAE;QACtB,SAAS,cAAc,CAAC,EAAE;QAC1B,OAAO,YAAY,CAAC,EAAE;QACtB;QACA,OAAO;QACP,WAAW,IAAI;QACf;IACF;AACF;AAEO,SAAS,gBAAgB,IAAwB;IACtD,IAAI,CAAC,MAAM;QACT,OAAO;IACT;IAEA,MAAM,SAAmB,EAAE;IAE3B,IAAI,KAAK,IAAI,EAAE,OAAO,IAAI,CAAC,KAAK,IAAI;IACpC,IAAI,KAAK,KAAK,EAAE,OAAO,IAAI,CAAC,CAAC,GAAG,EAAE,KAAK,KAAK,EAAE;IAC9C,IAAI,KAAK,KAAK,EAAE,OAAO,IAAI,CAAC,CAAC,IAAI,EAAE,KAAK,KAAK,EAAE;IAC/C,IAAI,KAAK,OAAO,EAAE,OAAO,IAAI,CAAC,CAAC,GAAG,EAAE,KAAK,OAAO,EAAE;IAClD,IAAI,KAAK,KAAK,EAAE,OAAO,IAAI,CAAC,CAAC,GAAG,EAAE,KAAK,KAAK,EAAE;IAE9C,IAAI,OAAO,MAAM,KAAK,GAAG;QACvB,OAAO;IACT;IAEA,OAAO,CAAC,SAAS,EAAE,OAAO,IAAI,CAAC,MAAM;AACvC"}},
    {"offset": {"line": 186, "column": 0}, "map": {"version":3,"sources":["file:///Users/haoqi/OnePersonCompany/friendsAI/packages/client/app/api/chat/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport {\n  buildProxyPayload,\n  buildToolResult,\n  extractAssistantReply,\n  extractContactCardFromText,\n  parseChatRequestBody,\n  ValidationError,\n} from './logic';\n\nconst LOCAL_AI_BASE_URL = process.env.LOCAL_AI_BASE_URL ?? 'http://127.0.0.1:9739/v1';\nconst LOCAL_AI_MODEL = process.env.LOCAL_AI_MODEL ?? 'gemini-3-flash';\nconst LOCAL_AI_API_KEY = process.env.LOCAL_AI_API_KEY ?? '';\n\nexport async function POST(request: Request) {\n  try {\n    if (!LOCAL_AI_API_KEY) {\n      return NextResponse.json({ error: '本地 AI 服务未配置密钥' }, { status: 500 });\n    }\n\n    const rawBody = await request.json();\n    const parsed = parseChatRequestBody(rawBody);\n    const payload = buildProxyPayload(parsed, LOCAL_AI_MODEL);\n\n    const proxyResponse = await fetch(`${LOCAL_AI_BASE_URL}/chat/completions`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${LOCAL_AI_API_KEY}`,\n      },\n      body: JSON.stringify(payload),\n      signal: AbortSignal.timeout(15000),\n    });\n\n    if (!proxyResponse.ok) {\n      return NextResponse.json({ error: '本地 AI 代理请求失败' }, { status: 502 });\n    }\n\n    const proxyData = (await proxyResponse.json()) as unknown;\n    const reply = extractAssistantReply(proxyData as { choices?: Array<{ message?: { content?: string } }> });\n\n    const latestUserMessage = [...parsed.messages]\n      .reverse()\n      .find((message) => message.role !== 'assistant');\n\n    const sourceMessageId = `source-${Date.now()}`;\n    const contactCard = latestUserMessage\n      ? extractContactCardFromText(latestUserMessage.content, parsed.contact.name, sourceMessageId)\n      : null;\n\n    const toolResult = buildToolResult(contactCard);\n\n    return NextResponse.json({\n      reply,\n      toolResult,\n      contactCard,\n    });\n  } catch (error) {\n    if (error instanceof ValidationError) {\n      return NextResponse.json({ error: error.message }, { status: 400 });\n    }\n\n    return NextResponse.json({ error: '请求处理失败' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AASA,MAAM,oBAAoB,QAAQ,GAAG,CAAC,iBAAiB,IAAI;AAC3D,MAAM,iBAAiB,QAAQ,GAAG,CAAC,cAAc,IAAI;AACrD,MAAM,mBAAmB,QAAQ,GAAG,CAAC,gBAAgB,IAAI;AAElD,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,IAAI,CAAC,kBAAkB;YACrB,OAAO,iLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,MAAM,UAAU,MAAM,QAAQ,IAAI;QAClC,MAAM,SAAS,IAAA,4MAAoB,EAAC;QACpC,MAAM,UAAU,IAAA,yMAAiB,EAAC,QAAQ;QAE1C,MAAM,gBAAgB,MAAM,MAAM,GAAG,kBAAkB,iBAAiB,CAAC,EAAE;YACzE,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,eAAe,CAAC,OAAO,EAAE,kBAAkB;YAC7C;YACA,MAAM,KAAK,SAAS,CAAC;YACrB,QAAQ,YAAY,OAAO,CAAC;QAC9B;QAEA,IAAI,CAAC,cAAc,EAAE,EAAE;YACrB,OAAO,iLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,YAAa,MAAM,cAAc,IAAI;QAC3C,MAAM,QAAQ,IAAA,6MAAqB,EAAC;QAEpC,MAAM,oBAAoB;eAAI,OAAO,QAAQ;SAAC,CAC3C,OAAO,GACP,IAAI,CAAC,CAAC,UAAY,QAAQ,IAAI,KAAK;QAEtC,MAAM,kBAAkB,CAAC,OAAO,EAAE,KAAK,GAAG,IAAI;QAC9C,MAAM,cAAc,oBAChB,IAAA,kNAA0B,EAAC,kBAAkB,OAAO,EAAE,OAAO,OAAO,CAAC,IAAI,EAAE,mBAC3E;QAEJ,MAAM,aAAa,IAAA,uMAAe,EAAC;QAEnC,OAAO,iLAAY,CAAC,IAAI,CAAC;YACvB;YACA;YACA;QACF;IACF,EAAE,OAAO,OAAO;QACd,IAAI,iBAAiB,uMAAe,EAAE;YACpC,OAAO,iLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,MAAM,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACnE;QAEA,OAAO,iLAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAS,GAAG;YAAE,QAAQ;QAAI;IAC9D;AACF"}}]
}
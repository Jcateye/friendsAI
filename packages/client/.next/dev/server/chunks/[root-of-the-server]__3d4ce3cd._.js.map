{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/haoqi/OnePersonCompany/friendsAI/packages/client/app/api/chat/logic.ts"],"sourcesContent":["import type { ContactCard } from '@/types';\n\ninterface ProxyMessage {\n  role: 'system' | 'user' | 'assistant';\n  content: string;\n}\n\ninterface ProxyResponse {\n  choices?: Array<{\n    message?: {\n      content?: string;\n    };\n  }>;\n}\n\nexport type ChatToolName = 'extract_contact_info' | 'feishu_template_message';\n\nexport interface ChatRequestInput {\n  contact: {\n    id: string;\n    name: string;\n  };\n  messages: Array<{\n    role: 'user' | 'assistant';\n    content: string;\n  }>;\n  tools?: {\n    enabled: ChatToolName[];\n    disabled?: ChatToolName[];\n    feishuTemplateMessage?: {\n      templateId?: string;\n      variables?: Record<string, string>;\n      mode?: 'sync' | 'preview';\n    };\n  };\n}\n\nexport class ValidationError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = 'ValidationError';\n  }\n}\n\nexport interface ChatApiPayload {\n  model: string;\n  messages: ProxyMessage[];\n  temperature: number;\n}\n\nconst DEFAULT_ENABLED_TOOLS: ChatToolName[] = ['extract_contact_info'];\nconst FEISHU_TEMPLATE_ID_MAX_LENGTH = 128;\nconst FEISHU_VARIABLE_MAX_ENTRIES = 50;\nconst FEISHU_VARIABLE_KEY_MAX_LENGTH = 64;\nconst FEISHU_VARIABLE_VALUE_MAX_LENGTH = 512;\nconst MAX_MESSAGES = 1000;\nconst MAX_MESSAGE_CONTENT_LENGTH = 12000;\nconst MAX_TOTAL_MESSAGE_CONTENT_LENGTH = 200000;\n\nfunction isPlainObject(value: unknown): value is Record<string, unknown> {\n  return Boolean(value) && typeof value === 'object' && !Array.isArray(value);\n}\n\nfunction parseToolNameArray(input: unknown, field: 'enabled' | 'disabled'): ChatToolName[] {\n  if (input === undefined) {\n    return field === 'enabled' ? [...DEFAULT_ENABLED_TOOLS] : [];\n  }\n\n  if (!Array.isArray(input)) {\n    throw new ValidationError(`tools.${field} 必须是数组`);\n  }\n\n  return Array.from(\n    new Set(\n      input.map((toolName: unknown): ChatToolName => {\n        if (toolName !== 'extract_contact_info' && toolName !== 'feishu_template_message') {\n          throw new ValidationError(`tools.${field} 包含不支持的工具`);\n        }\n\n        return toolName;\n      })\n    )\n  );\n}\n\nfunction parseTools(input: unknown): NonNullable<ChatRequestInput['tools']> {\n  if (input === undefined) {\n    return {\n      enabled: [...DEFAULT_ENABLED_TOOLS],\n      disabled: [],\n    };\n  }\n\n  if (!isPlainObject(input)) {\n    throw new ValidationError('tools 格式无效');\n  }\n\n  const enabled = parseToolNameArray(input.enabled, 'enabled');\n  const disabled = parseToolNameArray(input.disabled, 'disabled');\n\n  const feishuInput = input.feishuTemplateMessage;\n\n  if (feishuInput === undefined) {\n    return {\n      enabled,\n      disabled,\n    };\n  }\n\n  if (!isPlainObject(feishuInput)) {\n    throw new ValidationError('tools.feishuTemplateMessage 格式无效');\n  }\n\n  const templateIdInput = feishuInput.templateId;\n  if (templateIdInput !== undefined && typeof templateIdInput !== 'string') {\n    throw new ValidationError('tools.feishuTemplateMessage.templateId 必须是字符串');\n  }\n\n  const templateId = templateIdInput?.trim();\n  if (templateId && templateId.length > FEISHU_TEMPLATE_ID_MAX_LENGTH) {\n    throw new ValidationError('tools.feishuTemplateMessage.templateId 超出限制');\n  }\n\n  const modeInput = feishuInput.mode;\n  if (modeInput !== undefined && modeInput !== 'sync' && modeInput !== 'preview') {\n    throw new ValidationError('tools.feishuTemplateMessage.mode 无效');\n  }\n\n  const variablesInput = feishuInput.variables;\n  if (variablesInput !== undefined && !isPlainObject(variablesInput)) {\n    throw new ValidationError('tools.feishuTemplateMessage.variables 必须是对象');\n  }\n\n  const variablesEntries = Object.entries(variablesInput ?? {});\n\n  if (variablesEntries.length > FEISHU_VARIABLE_MAX_ENTRIES) {\n    throw new ValidationError('tools.feishuTemplateMessage.variables 条目过多');\n  }\n\n  const normalizedVariables = variablesEntries.reduce<Record<string, string>>((acc, [rawKey, rawValue]) => {\n    if (typeof rawValue !== 'string') {\n      throw new ValidationError('tools.feishuTemplateMessage.variables 的值必须是字符串');\n    }\n\n    const key = rawKey.trim();\n    const value = rawValue.trim();\n\n    if (!key || key.length > FEISHU_VARIABLE_KEY_MAX_LENGTH) {\n      throw new ValidationError('tools.feishuTemplateMessage.variables 的键超出限制');\n    }\n\n    if (value.length > FEISHU_VARIABLE_VALUE_MAX_LENGTH) {\n      throw new ValidationError('tools.feishuTemplateMessage.variables 的值超出限制');\n    }\n\n    return {\n      ...acc,\n      [key]: value,\n    };\n  }, {});\n\n  return {\n    enabled,\n    disabled,\n    feishuTemplateMessage: {\n      templateId,\n      variables: Object.keys(normalizedVariables).length > 0 ? normalizedVariables : undefined,\n      mode: modeInput ?? 'sync',\n    },\n  };\n}\n\nexport function isToolEnabled(request: Pick<ChatRequestInput, 'tools'>, toolName: ChatToolName): boolean {\n  const enabled = request.tools?.enabled ?? DEFAULT_ENABLED_TOOLS;\n  const disabled = request.tools?.disabled ?? [];\n\n  if (disabled.includes(toolName)) {\n    return false;\n  }\n\n  return enabled.includes(toolName);\n}\n\nexport function parseChatRequestBody(input: unknown): ChatRequestInput {\n  if (!input || typeof input !== 'object') {\n    throw new ValidationError('请求体必须是对象');\n  }\n\n  const body = input as Partial<ChatRequestInput> & { tools?: unknown };\n\n  if (!body.contact || typeof body.contact !== 'object') {\n    throw new ValidationError('缺少联系人信息');\n  }\n\n  if (typeof body.contact.id !== 'string' || typeof body.contact.name !== 'string') {\n    throw new ValidationError('联系人信息格式无效');\n  }\n\n  const contactId = body.contact.id.trim();\n  const contactName = body.contact.name.trim();\n\n  if (!contactId || contactId.length > 64 || !contactName || contactName.length > 80) {\n    throw new ValidationError('联系人信息超出限制');\n  }\n\n  if (!Array.isArray(body.messages) || body.messages.length === 0) {\n    throw new ValidationError('消息列表不能为空');\n  }\n\n  if (body.messages.length > MAX_MESSAGES) {\n    throw new ValidationError('消息条数超出限制');\n  }\n\n  const normalizedMessages = body.messages\n    .filter((message): message is { role: 'user' | 'assistant'; content: string } => {\n      if (!message || typeof message !== 'object') {\n        return false;\n      }\n\n      if (message.role !== 'user' && message.role !== 'assistant') {\n        return false;\n      }\n\n      return typeof message.content === 'string';\n    })\n    .map((message) => ({\n      role: message.role,\n      content: message.content.trim(),\n    }));\n\n  if (normalizedMessages.length === 0) {\n    throw new ValidationError('消息列表格式无效');\n  }\n\n  if (\n    normalizedMessages.some(\n      (message) => message.content.length === 0 || message.content.length > MAX_MESSAGE_CONTENT_LENGTH\n    )\n  ) {\n    throw new ValidationError('消息内容超出限制');\n  }\n\n  const totalMessageContentLength = normalizedMessages.reduce(\n    (sum, message) => sum + message.content.length,\n    0\n  );\n\n  if (totalMessageContentLength > MAX_TOTAL_MESSAGE_CONTENT_LENGTH) {\n    throw new ValidationError('消息总长度超出限制');\n  }\n\n  return {\n    contact: {\n      id: contactId,\n      name: contactName,\n    },\n    messages: normalizedMessages,\n    tools: parseTools(body.tools),\n  };\n}\n\nexport function buildProxyPayload(request: ChatRequestInput, model: string): ChatApiPayload {\n  const systemPrompt =\n    '你是朋友关系管理助手。请用简洁中文回复，并尽量提取用户对话里的联系人信息（如邮箱、手机号、公司、职位、标签）。';\n\n  const mappedMessages: ProxyMessage[] = request.messages.map((message) => {\n    const role = message.role === 'assistant' ? 'assistant' : 'user';\n    return {\n      role,\n      content: message.content,\n    };\n  });\n\n  return {\n    model,\n    temperature: 0.4,\n    messages: [\n      {\n        role: 'system',\n        content: systemPrompt,\n      },\n      ...mappedMessages,\n    ],\n  };\n}\n\nexport function extractAssistantReply(proxyResponse: ProxyResponse): string {\n  const content = proxyResponse.choices?.[0]?.message?.content;\n\n  if (!content || typeof content !== 'string') {\n    return '我已经记下来了。';\n  }\n\n  const normalized = content.trim();\n  return normalized || '我已经记下来了。';\n}\n\nexport function extractContactCardFromText(\n  text: string,\n  contactName: string,\n  sourceMessageId: string\n): ContactCard | null {\n  const normalized = text.trim();\n\n  if (!normalized) {\n    return null;\n  }\n\n  const emailMatch = normalized.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}/i);\n  const phoneMatch = normalized.match(/(?:\\+?86[-\\s]?)?1[3-9]\\d{9}/);\n  const titleMatch = normalized.match(/(工程师|产品经理|设计师|销售|运营|创始人|教师|医生)/);\n  const companyMatch = normalized.match(/(?:在|就职于|任职于)([^，。\\s]{2,20})(?:工作|任职|上班)?/);\n\n  const tags: string[] = [];\n  if (normalized.includes('React')) tags.push('React');\n  if (normalized.includes('AI')) tags.push('AI');\n  if (normalized.includes('创业')) tags.push('创业');\n\n  const hasAnyField = Boolean(emailMatch || phoneMatch || titleMatch || companyMatch || tags.length > 0);\n\n  if (!hasAnyField) {\n    return null;\n  }\n\n  return {\n    id: `${sourceMessageId}-card`,\n    name: contactName,\n    email: emailMatch?.[0],\n    phone: phoneMatch?.[0],\n    company: companyMatch?.[1],\n    title: titleMatch?.[0],\n    tags,\n    notes: '由 AI 对话自动提取',\n    createdAt: new Date(),\n    sourceMessageId,\n  };\n}\n\nexport function buildToolResult(card: ContactCard | null): string | undefined {\n  if (!card) {\n    return undefined;\n  }\n\n  const fields: string[] = [];\n\n  if (card.name) fields.push(card.name);\n  if (card.email) fields.push(`邮箱 ${card.email}`);\n  if (card.phone) fields.push(`手机号 ${card.phone}`);\n  if (card.company) fields.push(`公司 ${card.company}`);\n  if (card.title) fields.push(`职位 ${card.title}`);\n\n  if (fields.length === 0) {\n    return undefined;\n  }\n\n  return `已提取联系人信息：${fields.join('，')}`;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 301, "column": 0}, "map": {"version":3,"sources":["file:///Users/haoqi/OnePersonCompany/friendsAI/packages/client/app/api/feishu/bitable/logic.ts"],"sourcesContent":["export interface BitableSyncRequest {\n  contactId: string;\n  contactName: string;\n  messageId: string;\n  role: 'user' | 'assistant';\n  content: string;\n  occurredAt: string;\n  source: string;\n  extractedFields?: Record<string, string>;\n}\n\ninterface TenantTokenResponse {\n  code?: number;\n  msg?: string;\n  tenant_access_token?: string;\n}\n\ninterface BitableCreateRecordResponse {\n  code?: number;\n  msg?: string;\n  data?: {\n    record?: {\n      record_id?: string;\n    };\n  };\n}\n\nexport class ValidationError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = 'ValidationError';\n  }\n}\n\ninterface FeishuAuthConfig {\n  appId: string;\n  appSecret: string;\n  baseUrl: string;\n}\n\ninterface FeishuBitableConfig extends FeishuAuthConfig {\n  appToken: string;\n  tableId: string;\n}\n\nexport function parseBitableSyncRequestBody(input: unknown): BitableSyncRequest {\n  if (!input || typeof input !== 'object') {\n    throw new ValidationError('请求体必须是对象');\n  }\n\n  const body = input as Partial<BitableSyncRequest>;\n\n  if (\n    typeof body.contactId !== 'string' ||\n    typeof body.contactName !== 'string' ||\n    typeof body.messageId !== 'string' ||\n    typeof body.role !== 'string' ||\n    typeof body.content !== 'string' ||\n    typeof body.occurredAt !== 'string' ||\n    typeof body.source !== 'string'\n  ) {\n    throw new ValidationError('请求字段格式无效');\n  }\n\n  const contactId = body.contactId.trim();\n  const contactName = body.contactName.trim();\n  const messageId = body.messageId.trim();\n  const role = body.role.trim();\n  const content = body.content.trim();\n  const occurredAt = body.occurredAt.trim();\n  const source = body.source.trim();\n\n  if (!contactId || contactId.length > 64) {\n    throw new ValidationError('contactId 超出限制');\n  }\n\n  if (!contactName || contactName.length > 80) {\n    throw new ValidationError('contactName 超出限制');\n  }\n\n  if (!messageId || messageId.length > 64) {\n    throw new ValidationError('messageId 超出限制');\n  }\n\n  if (role !== 'user' && role !== 'assistant') {\n    throw new ValidationError('role 无效');\n  }\n\n  if (!content || content.length > 12000) {\n    throw new ValidationError('content 超出限制');\n  }\n\n  if (source !== 'chat') {\n    throw new ValidationError('source 无效');\n  }\n\n  const timestamp = Date.parse(occurredAt);\n  if (Number.isNaN(timestamp)) {\n    throw new ValidationError('occurredAt 时间格式无效');\n  }\n\n  const extractedFieldsInput = body.extractedFields;\n  if (extractedFieldsInput !== undefined) {\n    if (!extractedFieldsInput || typeof extractedFieldsInput !== 'object' || Array.isArray(extractedFieldsInput)) {\n      throw new ValidationError('extractedFields 格式无效');\n    }\n\n    const entries = Object.entries(extractedFieldsInput);\n    if (entries.length > 50) {\n      throw new ValidationError('extractedFields 条目过多');\n    }\n\n    for (const [key, value] of entries) {\n      if (typeof value !== 'string') {\n        throw new ValidationError('extractedFields 的值必须是字符串');\n      }\n\n      if (!key.trim() || key.trim().length > 64) {\n        throw new ValidationError('extractedFields 的键超出限制');\n      }\n\n      if (value.trim().length > 512) {\n        throw new ValidationError('extractedFields 的值超出限制');\n      }\n    }\n  }\n\n  return {\n    contactId,\n    contactName,\n    messageId,\n    role,\n    content,\n    occurredAt: new Date(timestamp).toISOString(),\n    source,\n    extractedFields:\n      extractedFieldsInput === undefined\n        ? undefined\n        : Object.fromEntries(\n            Object.entries(extractedFieldsInput).map(([key, value]) => [key.trim(), (value as string).trim()])\n          ),\n  };\n}\n\nexport function buildBitableRecordFields(payload: BitableSyncRequest): Record<string, string> {\n  return {\n    'Contact ID': payload.contactId,\n    'Contact Name': payload.contactName,\n    'Message ID': payload.messageId,\n    Role: payload.role,\n    Content: payload.content,\n    Source: payload.source,\n    'Occurred At': payload.occurredAt,\n    ...(payload.extractedFields ?? {}),\n  };\n}\n\nexport async function requestTenantAccessToken(\n  config: FeishuAuthConfig,\n  requestFn: typeof fetch = fetch\n): Promise<string> {\n  const response = await requestFn(`${config.baseUrl}/open-apis/auth/v3/tenant_access_token/internal`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      app_id: config.appId,\n      app_secret: config.appSecret,\n    }),\n    signal: AbortSignal.timeout(10000),\n  });\n\n  if (!response.ok) {\n    throw new Error('获取飞书租户令牌失败');\n  }\n\n  const data = (await response.json()) as TenantTokenResponse;\n\n  if (data.code !== 0 || !data.tenant_access_token) {\n    throw new Error('获取飞书租户令牌失败');\n  }\n\n  return data.tenant_access_token;\n}\n\nexport async function syncMessageToBitable(\n  input: {\n    payload: BitableSyncRequest;\n    config: FeishuBitableConfig;\n  },\n  requestFn: typeof fetch = fetch\n): Promise<{ recordId: string }> {\n  const token = await requestTenantAccessToken(input.config, requestFn);\n\n  const response = await requestFn(\n    `${input.config.baseUrl}/open-apis/bitable/v1/apps/${input.config.appToken}/tables/${input.config.tableId}/records`,\n    {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${token}`,\n      },\n      body: JSON.stringify({\n        fields: buildBitableRecordFields(input.payload),\n      }),\n      signal: AbortSignal.timeout(10000),\n    }\n  );\n\n  if (!response.ok) {\n    throw new Error('写入飞书多维表失败');\n  }\n\n  const data = (await response.json()) as BitableCreateRecordResponse;\n  const recordId = data.data?.record?.record_id;\n\n  if (data.code !== 0 || !recordId) {\n    throw new Error('写入飞书多维表失败');\n  }\n\n  return { recordId };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 453, "column": 0}, "map": {"version":3,"sources":["file:///Users/haoqi/OnePersonCompany/friendsAI/packages/client/app/api/chat/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport {\n  buildProxyPayload,\n  buildToolResult,\n  extractAssistantReply,\n  extractContactCardFromText,\n  isToolEnabled,\n  parseChatRequestBody,\n  ValidationError,\n} from './logic';\nimport { parseBitableSyncRequestBody, syncMessageToBitable } from '../feishu/bitable/logic';\n\nconst LOCAL_AI_BASE_URL = process.env.LOCAL_AI_BASE_URL ?? 'http://127.0.0.1:9739/v1';\nconst LOCAL_AI_MODEL = process.env.LOCAL_AI_MODEL ?? 'claude-sonnet-4-5-thinking';\nconst LOCAL_AI_API_KEY = process.env.LOCAL_AI_API_KEY ?? '';\nconst FEISHU_SYNC_ENABLED = process.env.FEISHU_SYNC_ENABLED === 'true';\nconst FEISHU_CHAT_TOOL_ENABLED = process.env.FEISHU_CHAT_TOOL_ENABLED === 'true';\nconst FEISHU_BASE_URL = process.env.FEISHU_BASE_URL ?? 'https://open.feishu.cn';\nconst FEISHU_APP_ID = process.env.FEISHU_APP_ID ?? '';\nconst FEISHU_APP_SECRET = process.env.FEISHU_APP_SECRET ?? '';\nconst FEISHU_BITABLE_APP_TOKEN = process.env.FEISHU_BITABLE_APP_TOKEN ?? '';\nconst FEISHU_BITABLE_TABLE_ID = process.env.FEISHU_BITABLE_TABLE_ID ?? '';\nconst FEISHU_FIELD_MAPPING_JSON = process.env.FEISHU_FIELD_MAPPING_JSON ?? '';\nconst RESERVED_FEISHU_FIELDS = new Set([\n  'Contact ID',\n  'Contact Name',\n  'Message ID',\n  'Role',\n  'Content',\n  'Source',\n  'Occurred At',\n]);\n\nfunction createRequestId(): string {\n  return `chat-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;\n}\n\nfunction sanitizeForLog(value: unknown, maxLength: number): string | undefined {\n  if (typeof value !== 'string') {\n    return undefined;\n  }\n\n  return value.replace(/[\\r\\n\\t\\0]/g, ' ').slice(0, maxLength);\n}\n\nfunction summarizeToolList(input: unknown): string[] | undefined {\n  if (!Array.isArray(input)) {\n    return undefined;\n  }\n\n  return input\n    .slice(0, 10)\n    .map((item) => sanitizeForLog(item, 32) ?? typeof item);\n}\n\nfunction parseFeishuFieldMapping(raw: string): Record<string, string> {\n  const normalized = raw.trim();\n  if (!normalized) {\n    return {};\n  }\n\n  const parsed = JSON.parse(normalized) as unknown;\n  if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {\n    throw new Error('FEISHU_FIELD_MAPPING_JSON must be an object');\n  }\n\n  return Object.entries(parsed).reduce<Record<string, string>>((acc, [rawKey, rawValue]) => {\n    if (typeof rawValue !== 'string') {\n      throw new Error('FEISHU_FIELD_MAPPING_JSON values must be strings');\n    }\n\n    const key = rawKey.trim();\n    const value = rawValue.trim();\n\n    if (!key || !value) {\n      throw new Error('FEISHU_FIELD_MAPPING_JSON contains empty key/value');\n    }\n\n    if (RESERVED_FEISHU_FIELDS.has(value)) {\n      throw new Error('FEISHU_FIELD_MAPPING_JSON maps to reserved field');\n    }\n\n    return {\n      ...acc,\n      [key]: value,\n    };\n  }, {});\n}\n\nfunction summarizeRawBody(rawBody: unknown): Record<string, unknown> {\n  if (!rawBody || typeof rawBody !== 'object' || Array.isArray(rawBody)) {\n    return {\n      rawBodyType: Array.isArray(rawBody) ? 'array' : typeof rawBody,\n    };\n  }\n\n  const candidate = rawBody as {\n    contact?: { id?: unknown };\n    messages?: unknown;\n    tools?: { enabled?: unknown; disabled?: unknown; feishuTemplateMessage?: { mode?: unknown } };\n  };\n\n  const messages = Array.isArray(candidate.messages) ? candidate.messages : [];\n\n  return {\n    contactId: sanitizeForLog(candidate.contact?.id, 64),\n    messageCount: messages.length,\n    messageRoles: messages\n      .slice(0, 5)\n      .map((message) => {\n        if (!message || typeof message !== 'object') {\n          return 'invalid';\n        }\n\n        return sanitizeForLog((message as { role?: unknown }).role, 24) ?? 'missing';\n      }),\n    enabledTools: summarizeToolList(candidate.tools?.enabled),\n    disabledTools: summarizeToolList(candidate.tools?.disabled),\n    feishuMode: sanitizeForLog(candidate.tools?.feishuTemplateMessage?.mode, 24),\n  };\n}\n\nfunction mapExtractedFields(\n  extractedFields: Record<string, string> | undefined,\n  fieldMapping: Record<string, string>\n): Record<string, string> | undefined {\n  if (!extractedFields) {\n    return undefined;\n  }\n\n  return Object.entries(extractedFields).reduce<Record<string, string>>((acc, [key, value]) => {\n    const mappedKey = fieldMapping[key] ?? key;\n    return {\n      ...acc,\n      [mappedKey]: value,\n    };\n  }, {});\n}\n\nexport async function POST(request: Request) {\n  const requestId = createRequestId();\n  const startedAt = Date.now();\n  let rawBodySummary: Record<string, unknown> = {};\n\n  try {\n    if (!LOCAL_AI_API_KEY) {\n      console.error('[api/chat] local AI key missing', { requestId });\n      return NextResponse.json({ error: '本地 AI 服务未配置密钥', requestId }, { status: 500 });\n    }\n\n    let rawBody: unknown;\n    try {\n      rawBody = await request.json();\n    } catch {\n      console.error('[api/chat] invalid json body', {\n        requestId,\n        elapsedMs: Date.now() - startedAt,\n      });\n      return NextResponse.json({ error: '请求体 JSON 无效', requestId }, { status: 400 });\n    }\n    rawBodySummary = summarizeRawBody(rawBody);\n\n    console.info('[api/chat] request received', {\n      requestId,\n      ...rawBodySummary,\n    });\n\n    const parsed = parseChatRequestBody(rawBody);\n    const payload = buildProxyPayload(parsed, LOCAL_AI_MODEL);\n\n    let feishuFieldMapping: Record<string, string> = {};\n    try {\n      feishuFieldMapping = parseFeishuFieldMapping(FEISHU_FIELD_MAPPING_JSON);\n    } catch (error) {\n      console.warn('[api/chat] invalid feishu field mapping config', {\n        requestId,\n        error: error instanceof Error ? error.message : String(error),\n      });\n    }\n\n    const proxyResponse = await fetch(`${LOCAL_AI_BASE_URL}/chat/completions`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${LOCAL_AI_API_KEY}`,\n      },\n      body: JSON.stringify(payload),\n      signal: AbortSignal.timeout(45000),\n    });\n\n    if (!proxyResponse.ok) {\n      if (proxyResponse.status === 429) {\n        console.warn('[api/chat] upstream rate limited', {\n          requestId,\n          status: proxyResponse.status,\n          statusText: proxyResponse.statusText,\n          elapsedMs: Date.now() - startedAt,\n        });\n\n        return NextResponse.json(\n          {\n            reply: '当前 AI 服务请求较多，请稍后重试。',\n            requestId,\n            rateLimited: true,\n          },\n          { status: 200 }\n        );\n      }\n\n      console.error('[api/chat] upstream failed', {\n        requestId,\n        status: proxyResponse.status,\n        statusText: proxyResponse.statusText,\n        elapsedMs: Date.now() - startedAt,\n      });\n\n      return NextResponse.json({ error: '本地 AI 代理请求失败', requestId }, { status: 502 });\n    }\n\n    const proxyData = (await proxyResponse.json()) as unknown;\n    const reply = extractAssistantReply(proxyData as { choices?: Array<{ message?: { content?: string } }> });\n\n    const latestUserMessage = [...parsed.messages].reverse().find((message) => message.role === 'user');\n\n    const sourceMessageId = `source-${Date.now()}`;\n    const canExtractContactInfo = isToolEnabled(parsed, 'extract_contact_info');\n    const canUseFeishuTemplateMessage =\n      FEISHU_CHAT_TOOL_ENABLED && isToolEnabled(parsed, 'feishu_template_message');\n    const feishuMode = parsed.tools?.feishuTemplateMessage?.mode ?? 'sync';\n\n    const extractedContactCard = canExtractContactInfo && latestUserMessage\n      ? extractContactCardFromText(latestUserMessage.content, parsed.contact.name, sourceMessageId)\n      : null;\n\n    const contactCard = canExtractContactInfo ? extractedContactCard ?? undefined : undefined;\n    const toolResult = canExtractContactInfo ? buildToolResult(extractedContactCard) : undefined;\n\n    const extractedFields = canExtractContactInfo\n      ? mapExtractedFields(\n          extractedContactCard\n            ? {\n                ...(extractedContactCard.email ? { Email: extractedContactCard.email } : {}),\n                ...(extractedContactCard.phone ? { Phone: extractedContactCard.phone } : {}),\n                ...(extractedContactCard.company ? { Company: extractedContactCard.company } : {}),\n                ...(extractedContactCard.title ? { Title: extractedContactCard.title } : {}),\n                ...(extractedContactCard.tags && extractedContactCard.tags.length > 0\n                  ? { Tags: extractedContactCard.tags.join(', ') }\n                  : {}),\n              }\n            : undefined,\n          feishuFieldMapping\n        )\n      : undefined;\n\n    if (\n      canUseFeishuTemplateMessage &&\n      feishuMode === 'sync' &&\n      FEISHU_SYNC_ENABLED &&\n      FEISHU_APP_ID &&\n      FEISHU_APP_SECRET &&\n      FEISHU_BITABLE_APP_TOKEN &&\n      FEISHU_BITABLE_TABLE_ID &&\n      latestUserMessage &&\n      latestUserMessage.role === 'user'\n    ) {\n      try {\n        const feishuPayload = parseBitableSyncRequestBody({\n          contactId: parsed.contact.id,\n          contactName: parsed.contact.name,\n          messageId: sourceMessageId,\n          role: 'user',\n          content: latestUserMessage.content,\n          occurredAt: new Date().toISOString(),\n          source: 'chat',\n          extractedFields,\n        });\n\n        await syncMessageToBitable({\n          payload: feishuPayload,\n          config: {\n            baseUrl: FEISHU_BASE_URL,\n            appId: FEISHU_APP_ID,\n            appSecret: FEISHU_APP_SECRET,\n            appToken: FEISHU_BITABLE_APP_TOKEN,\n            tableId: FEISHU_BITABLE_TABLE_ID,\n          },\n        });\n      } catch (error) {\n        console.error('[api/chat] feishu sync failed', {\n          requestId,\n          contactId: sanitizeForLog(parsed.contact.id, 64),\n          messageId: sourceMessageId,\n          error: error instanceof Error ? error.message : String(error),\n        });\n      }\n    }\n\n    console.info('[api/chat] request completed', {\n      requestId,\n      contactId: sanitizeForLog(parsed.contact.id, 64),\n      messageCount: parsed.messages.length,\n      extractedContactCard: Boolean(contactCard),\n      elapsedMs: Date.now() - startedAt,\n    });\n\n    return NextResponse.json({\n      reply,\n      toolResult,\n      contactCard,\n      requestId,\n    });\n  } catch (error) {\n    if (error instanceof ValidationError) {\n      console.error('[api/chat] validation failed', {\n        requestId,\n        error: error.message,\n        elapsedMs: Date.now() - startedAt,\n        ...rawBodySummary,\n      });\n      return NextResponse.json({ error: error.message, requestId }, { status: 400 });\n    }\n\n    console.error('[api/chat] unexpected failure', {\n      requestId,\n      error: error instanceof Error ? error.message : String(error),\n      elapsedMs: Date.now() - startedAt,\n      ...rawBodySummary,\n    });\n\n    return NextResponse.json({ error: '请求处理失败', requestId }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}
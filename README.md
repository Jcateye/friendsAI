# FriendsAI

AI-powered relationship management app - æ™ºèƒ½ç¤¾äº¤å…³ç³»ç®¡ç†åº”ç”¨

## 1. é¡¹ç›®ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªåŸºäº **AI Native** ç†å¿µè®¾è®¡çš„ä¸ªäºº/å°å›¢é˜Ÿäººè„‰ç®¡ç†ç³»ç»Ÿã€‚ä¸ä¼ ç»Ÿ CRM ä¸åŒï¼Œå®ƒä¸ä¾èµ–ç¹ççš„è¡¨å•è¾“å…¥ï¼Œè€Œæ˜¯é€šè¿‡**è‡ªç„¶è¯­è¨€äº¤äº’**ï¼ˆå¯¹è¯å½•éŸ³/ç¬”è®°ï¼‰æ¥è‡ªåŠ¨æ²‰æ·€äººè„‰æ•°æ®ã€‚ç³»ç»Ÿåˆ©ç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è¿›è¡Œä¿¡æ¯æå–ã€ç”»åƒæ„å»ºï¼Œå¹¶åˆ©ç”¨å‘é‡æ•°æ®åº“å®ç°æ™ºèƒ½æ£€ç´¢å’Œæ¨èã€‚

### æ ¸å¿ƒä»·å€¼
*   **æ— æ„Ÿè¾“å…¥**ï¼šè®°å½•å³å½’æ¡£ï¼ŒAI è‡ªåŠ¨æå–è”ç³»äººã€äº‹ä»¶ã€å¾…åŠã€‚
*   **æ™ºèƒ½è¾…åŠ©**ï¼šä¼šå‰ä¸€é”®ç”Ÿæˆç®€æŠ¥ï¼Œä¼šåè‡ªåŠ¨æ•´ç†çºªè¦ã€‚
*   **ä¸»åŠ¨æ¨è**ï¼šåŸºäºå…³ç³»æ·±åº¦å’Œæ—¶é—´ç»´åº¦çš„"è¡ŒåŠ¨é¢æ¿"ï¼Œé€šè¿‡ AI å»ºè®®"ä»Šå¤©è¯¥è”ç³»è°"ã€‚

## ä¸»çº¿è¯´æ˜ï¼ˆNestJS v2ï¼‰

- é»˜è®¤åç«¯ä¸»çº¿ï¼š`packages/server-nestjs`ï¼ˆNestJSï¼ŒAPI å‰ç¼€ `/v1`ï¼‰
- æ–°æ•°æ®åº“ï¼š`friendsai_v2`ï¼ˆé€šè¿‡ `DATABASE_URL` æŒ‡å‘ï¼‰
- `packages/server` ä¸ºæ—§ç‰ˆ Expressï¼Œä»…ç”¨äºå›æ»š/å¯¹ç…§

## 2. é¡¹ç›®ç»“æ„

```
friendsAI/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ client/              # å‰ç«¯åº”ç”¨ (Taro è·¨å¹³å°)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ server-nestjs/       # [MAIN] AI åŸç”Ÿåç«¯æœåŠ¡ (NestJS, /v1)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ action-panel/ # è¡ŒåŠ¨é¢æ¿æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ ai/           # AI æ ¸å¿ƒä¸å‘é‡æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/         # è®¤è¯æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ briefings/    # ä¼šå‰ç®€æŠ¥æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ contacts/     # è”ç³»äººç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ conversations/# å¯¹è¯å¤„ç†ä¸ AI è§£æ
â”‚   â”‚   â”‚   â”œâ”€â”€ events/       # äº‹ä»¶ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ entities/     # æ•°æ®åº“å®ä½“
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â””â”€â”€ server/              # [LEGACY/ROLLBACK] æ—§ç‰ˆåç«¯ (Express)
â”‚
â”œâ”€â”€ designs/                 # è®¾è®¡æ–‡ä»¶ (.pen)
â”œâ”€â”€ docs/                    # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ docker-compose.yml       # æ•°æ®åº“ç¼–æ’ (PostgreSQL + PGVector)
â””â”€â”€ README.md
```

## 3. æŠ€æœ¯æ ˆ

### å‰ç«¯ (packages/client)
- **æ¡†æ¶**: Taro 3.6 (è·¨å¹³å°å°ç¨‹åºæ¡†æ¶)
- **UI**: React 18 + taro-ui
- **è¯­è¨€**: TypeScript

### åç«¯ (packages/server-nestjs) - æ–°ç‰ˆ AI Native åç«¯
- **æ¡†æ¶**: NestJS (Node.js + TypeScript)
- **æ•°æ®åº“**: PostgreSQL 15
- **å‘é‡æ‰©å±•**: PGVector (ç”¨äºå­˜å‚¨å’Œæ£€ç´¢ Embedding)
- **ORM**: TypeORM
- **AI SDK**: OpenAI Node.js SDK
- **æµ‹è¯•**: Jest

### åç«¯ (packages/server) - æ—§ç‰ˆåç«¯ï¼ˆå·²å¼ƒç”¨ï¼‰
- **æ¡†æ¶**: Express.js
- **è¯­è¨€**: TypeScript
- **è¿è¡Œæ—¶**: Node.js 18+
- **åŒ…ç®¡ç†**: Bun

## 4. åŠŸèƒ½æ¨¡å—è¯¦è§£

### ğŸ›¡ï¸ è®¤è¯ä¸ç”¨æˆ·æ¨¡å— (Auth & Users)
*   **åŠŸèƒ½**ï¼šå¤„ç†ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ç™»å‡ºã€‚
*   **æœºåˆ¶**ï¼šJWT access/refreshï¼ˆrefresh æŒä¹…åŒ–ï¼‰ï¼Œå¯†ç é‡‡ç”¨ bcrypt å“ˆå¸Œå­˜å‚¨ã€‚

### ğŸ‘¥ è”ç³»äººç®¡ç† (Contacts)
*   **åŠŸèƒ½**ï¼šè”ç³»äººå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
*   **ç‰¹ç‚¹**ï¼šæ”¯æŒ JSONB æ ¼å¼çš„çµæ´»ç”»åƒï¼ˆProfileï¼‰å’Œæ ‡ç­¾ç³»ç»Ÿï¼Œé€‚åº”éç»“æ„åŒ–ä¿¡æ¯å­˜å‚¨ã€‚

### ğŸ’¬ å¯¹è¯ä¸äº‹ä»¶ (Conversations & Events)
*   **åŠŸèƒ½**ï¼š
    *   **å¯¹è¯**ï¼šè®°å½•ç”¨æˆ·è¾“å…¥çš„è‡ªç„¶è¯­è¨€ç¬”è®°ã€‚
    *   **äº‹ä»¶**ï¼šå­˜å‚¨å…·ä½“çš„æ—¥ç¨‹å’Œäº¤äº’è®°å½•ã€‚
*   **AI èƒ½åŠ›**ï¼šæ‰€æœ‰å†…å®¹è‡ªåŠ¨ç”Ÿæˆ Embedding å‘é‡ï¼Œæ”¯æŒè¯­ä¹‰æœç´¢ã€‚

### ğŸ§  AI å¤„ç†å™¨ (Conversation Processor)
*   **æ ¸å¿ƒé€»è¾‘**ï¼š
    1.  æ¥æ”¶è‡ªç„¶è¯­è¨€è¾“å…¥ã€‚
    2.  è°ƒç”¨ LLM æå–è”ç³»äººã€äº‹ä»¶ã€äº‹å®å’Œå¾…åŠäº‹é¡¹ã€‚
    3.  è‡ªåŠ¨æ›´æ–°æˆ–åˆ›å»ºå…³è”çš„å®ä½“æ•°æ®ã€‚
    4.  å½’æ¡£è§£æç»“æœã€‚

### ğŸ“ ä¼šå‰ç®€æŠ¥ (Briefings)
*   **åŠŸèƒ½**ï¼šåœ¨è§é¢å‰ç”Ÿæˆ"ä½œå¼Šå°æŠ„"ã€‚
*   **é€»è¾‘**ï¼šèšåˆè”ç³»äººåŸºç¡€ä¿¡æ¯ + æœ€è¿‘ 5 æ¬¡å¯¹è¯ + æœ€è¿‘ 5 ä¸ªäº‹ä»¶ -> LLM ç”Ÿæˆç®€è¦å›é¡¾å’Œè¯é¢˜å»ºè®®ã€‚

### ğŸš€ è¡ŒåŠ¨é¢æ¿ (Action Panel)
*   **åŠŸèƒ½**ï¼šé¦–é¡µä»ªè¡¨ç›˜ã€‚
*   **å¾…è·Ÿè¿›**ï¼šåŸºäºæœ€åäº¤äº’æ—¶é—´æ’åºã€‚
*   **AI æ¨è**ï¼šæ™ºèƒ½æ¨è"å³åˆ»è”ç³»"çš„å¯¹è±¡ï¼Œå¹¶ç”Ÿæˆæ¨èç†ç”±å’Œå¼€åœºç™½ã€‚

## 5. å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚
- Node.js >= 18.0.0
- Bun >= 1.2.0 (ç”¨äºæ—§ç‰ˆåç«¯)
- Docker (ç”¨äºè¿è¡Œæ•°æ®åº“)
- OpenAI API Key

### å¯åŠ¨æ­¥éª¤

1.  **å¯åŠ¨åŸºç¡€è®¾æ–½**
    åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼š
    ```bash
    docker-compose up -d
    ```
    *   å¯åŠ¨ PostgreSQL (ç«¯å£ 5434) å’Œ PGVectorã€‚

2.  **é…ç½®åç«¯ç¯å¢ƒ**
    è¿›å…¥ `packages/server-nestjs` å¹¶åˆ›å»º `.env` æ–‡ä»¶ï¼ˆä¸»çº¿æ•°æ®åº“ä¸º `friendsai_v2`ï¼‰ï¼š
    ```env
    DATABASE_URL=postgres://friendsai:friendsai@localhost:5434/friendsai_v2
    JWT_SECRET=dev-smoke-secret
    OPENAI_API_KEY=your-openai-api-key
    ```

3.  **å®‰è£…ä¾èµ–å¹¶è¿è¡Œ migrations**
    ```bash
    cd packages/server-nestjs
    npm install
    npm run migrate
    ```

4.  **å¯åŠ¨åç«¯**
    ```bash
    npm run start:dev
    ```
    æœåŠ¡å°†è¿è¡Œåœ¨ `http://localhost:3000`ï¼Œå¥åº·æ£€æŸ¥ï¼š`http://localhost:3000/v1/health`ã€‚

5.  **è¿è¡Œæœ€å° e2e æµ‹è¯•**
    ```bash
    npm run test:e2e
    ```

### Smoke æµ‹è¯•ï¼ˆNestJS ä¸»çº¿ï¼‰

```bash
node scripts/smoke-v2.js
```

å¯é€‰ç¯å¢ƒå˜é‡ï¼š
`SMOKE_BASE_URL`ï¼ˆé»˜è®¤ `http://localhost:3000/v1`ï¼‰ã€`SMOKE_EMAIL`ã€`SMOKE_PASSWORD`ã€‚

> æ³¨æ„ï¼šèŠå¤©ä¸ç®€æŠ¥ä¾èµ– `OPENAI_API_KEY`ã€‚

### ä¸»çº¿ä¸å›æ»šè¯´æ˜

- **ä¸»çº¿åç«¯**ï¼š`packages/server-nestjs`ï¼ˆé»˜è®¤ `/v1`ï¼‰
- **ä¸»çº¿æ•°æ®åº“**ï¼š`friendsai_v2`
- **å›æ»šæ–¹å¼**ï¼š
  1. å°†é»˜è®¤å¯åŠ¨è„šæœ¬æŒ‡å› `packages/server`ï¼ˆExpressï¼‰
  2. å‰ç«¯åˆ‡å›æ—§ API BASE_URL
  3. ç»§ç»­ä½¿ç”¨æ—§æ•°æ®åº“ï¼ˆä¸å›è¿ `friendsai_v2` æ•°æ®ï¼‰

### MVP ä¸€é”®å¯åŠ¨ï¼ˆæ—§ç‰ˆï¼‰

```bash
./project.sh start:mvp
```

### ä½¿ç”¨ bun è„šæœ¬ï¼ˆä¸»çº¿ï¼‰

```bash
bun run dev              # åŒæ—¶å¯åŠ¨å‰åç«¯
bun run client:dev       # å‰ç«¯ H5 å¼€å‘
bun run client:dev:weapp # å¾®ä¿¡å°ç¨‹åºå¼€å‘
bun run server:dev       # åç«¯å¼€å‘
bun run build            # æ„å»ºå‰åç«¯
```

### bun è„šæœ¬è¯´æ˜

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `bun run dev` | åŒæ—¶å¯åŠ¨å‰åç«¯å¼€å‘æœåŠ¡ |
| `bun run build` | æ„å»ºå‰åç«¯ |
| `bun run client:dev` | å‰ç«¯ H5 å¼€å‘æ¨¡å¼ |
| `bun run client:dev:weapp` | å‰ç«¯å¾®ä¿¡å°ç¨‹åºå¼€å‘æ¨¡å¼ |
| `bun run client:build` | æ„å»ºå‰ç«¯ H5 |
| `bun run client:build:weapp` | æ„å»ºå¾®ä¿¡å°ç¨‹åº |
| `bun run server:dev` | åç«¯å¼€å‘æ¨¡å¼ |
| `bun run server:build` | æ„å»ºåç«¯ |
| `bun run server:start` | å¯åŠ¨åç«¯ç”Ÿäº§æœåŠ¡ |

## 6. é¡¹ç›®æ¨¡å—è¯´æ˜

### packages/client - å‰ç«¯æ¨¡å—

| ç›®å½•/æ–‡ä»¶ | è¯´æ˜ |
|-----------|------|
| `src/components/` | å¯å¤ç”¨ UI ç»„ä»¶ (TabBar, Header, ContactCard ç­‰) |
| `src/pages/` | é¡µé¢ç»„ä»¶ (login, contacts, conversation ç­‰) |
| `src/services/api.ts` | API æ¥å£å°è£… |
| `src/types/` | TypeScript ç±»å‹å®šä¹‰ |
| `src/utils/` | å·¥å…·å‡½æ•° |
| `config/` | ç¯å¢ƒé…ç½® (dev.ts, prod.ts) |

### packages/server - åç«¯æ¨¡å—

| ç›®å½• | è¯´æ˜ |
|------|------|
| `src/routes/` | API è·¯ç”±å®šä¹‰ |
| `src/controllers/` | è¯·æ±‚å¤„ç†æ§åˆ¶å™¨ |
| `src/services/` | ä¸šåŠ¡é€»è¾‘æœåŠ¡ |
| `src/models/` | æ•°æ®æ¨¡å‹ |
| `src/middleware/` | Express ä¸­é—´ä»¶ |
| `src/utils/` | å·¥å…·å‡½æ•° |
| `src/types/` | TypeScript ç±»å‹å®šä¹‰ |

### designs/ - è®¾è®¡æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `pencil-friendsAI.pen` | FriendsAI ä¸»è®¾è®¡æ–‡ä»¶ |
| `pencil-codex.pen` | Codex ç›¸å…³è®¾è®¡ |
| `pencil-gemini.pen` | Gemini ç›¸å…³è®¾è®¡ |

### docs/ - é¡¹ç›®æ–‡æ¡£

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `AGENTS.md` | AI åŠ©æ‰‹ä½¿ç”¨æŒ‡å— |
| `CLAUDE.md` | Claude é…ç½®è¯´æ˜ |

### logs/ - è¿è¡Œæ—¥å¿—

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `client.log` | å‰ç«¯æœåŠ¡æ—¥å¿— |
| `server.log` | åç«¯æœåŠ¡æ—¥å¿— |

## 7. æ³¨æ„äº‹é¡¹

### å‰ç«¯å¼€å‘
1. å‰ç«¯ä»£ç ä½äº `packages/client/src`
2. è·¯å¾„åˆ«å `@/*` æ˜ å°„åˆ° `packages/client/src/*`
3. å°ç¨‹åºå¼€å‘éœ€è¦é…ç½®å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼ŒæŒ‡å‘ `packages/client/dist` ç›®å½•
4. ä¿®æ”¹ `packages/client/project.config.json` ä¸­çš„ `appid` ä¸ºä½ çš„å°ç¨‹åº ID

### åç«¯å¼€å‘
1. åç«¯ä»£ç ä½äº `packages/server/src`
2. ä½¿ç”¨ç¯å¢ƒæ–‡ä»¶ `packages/server/.env.development` / `packages/server/.env.production` é…ç½®ç¯å¢ƒå˜é‡
3. ç«¯å£é€šè¿‡ `PORT` é…ç½®ï¼ˆå¼€å‘é»˜è®¤ 3000ï¼‰

### å‰ç«¯é…ç½®
1. å‰ç«¯ç¯å¢ƒæ–‡ä»¶ä½äº `packages/client/.env.development` / `packages/client/.env.production`
2. H5 ç«¯å£é€šè¿‡ `CLIENT_PORT` é…ç½®ï¼ˆå¼€å‘é»˜è®¤ 10086ï¼‰
3. API åŸºåœ°å€é€šè¿‡ `TARO_APP_API_BASE_URL` é…ç½®

### Monorepo ç»“æ„
1. ä½¿ç”¨ npm workspaces ç®¡ç†å¤šåŒ…
2. å…±äº«ä¾èµ–ä¼šæå‡åˆ°æ ¹ç›®å½• `node_modules`
3. å„åŒ…çš„ä¸“å±ä¾èµ–åœ¨å„è‡ªçš„ `package.json` ä¸­å£°æ˜
4. ä½¿ç”¨ `-w` å‚æ•°å¯ä»¥åœ¨æ ¹ç›®å½•è¿è¡Œå­åŒ…è„šæœ¬

### è®¾è®¡æ–‡ä»¶
1. æ‰€æœ‰ `.pen` è®¾è®¡æ–‡ä»¶ç»Ÿä¸€å­˜æ”¾åœ¨ `designs/` ç›®å½•
2. ä½¿ç”¨ Pencil MCP å·¥å…·ç¼–è¾‘è®¾è®¡æ–‡ä»¶

## 8. é—ç•™é—®é¢˜ä¸æŠ€æœ¯å€ºåŠ¡

### âš ï¸ Task 12: `ConversationProcessorService` å•å…ƒæµ‹è¯•
*   **çŠ¶æ€**ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å·²å®ç°å¹¶ç»è¿‡ä»£ç å®¡æŸ¥ï¼Œä½†å¯¹åº”çš„å•å…ƒæµ‹è¯•æ–‡ä»¶ (`conversation-processor.service.spec.ts`) ç›®å‰æ— æ³•é€šè¿‡ã€‚
*   **åŸå› **ï¼š
    *   NestJS æµ‹è¯•æ¨¡å—ä¸­å¤æ‚çš„ä¾èµ–æ³¨å…¥ï¼ˆç‰¹åˆ«æ˜¯ `ConfigService` å’Œ `AiService` çš„äº¤äº’ï¼‰ã€‚
    *   Jest `spyOn` ä¸ TypeScript ç±»å‹æ¨æ–­åœ¨æ¨¡æ‹Ÿå¯¹è±¡çŠ¶æ€ä¼ é€’æ—¶çš„å†²çªã€‚
    *   éœ€è¦ç²¾ç¡®åŒ¹é…å¤šè¡Œ AI Prompt å­—ç¬¦ä¸²ã€‚
*   **å»ºè®®**ï¼šåœ¨åç»­è¿­ä»£ä¸­ï¼Œå»ºè®®äººå·¥ä»‹å…¥é‡æ„æ­¤æµ‹è¯•ï¼Œæˆ–è¡¥å……ç«¯åˆ°ç«¯ (E2E) æµ‹è¯•ä»¥è¦†ç›–æ­¤æ ¸å¿ƒè·¯å¾„ã€‚

## License

Private

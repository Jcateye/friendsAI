# é£ä¹¦æœºå™¨äºº + å¤šç»´è¡¨æ ¼é›†æˆè®¾è®¡æ–¹æ¡ˆ

**é¡¹ç›®**: friendsAI
**æ¨¡å—**: é£ä¹¦é›†æˆ
**ç‰ˆæœ¬**: v1.0
**æ—¥æœŸ**: 2026-02-10

---

## 1. æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

å°† friendsAI çš„ AI åˆ†æèƒ½åŠ›ä¸é£ä¹¦æ·±åº¦é›†æˆï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿåœ¨é£ä¹¦å†…å®Œæˆè”ç³»äººåˆ†æã€äº‹å®æå–ã€å¾…åŠç®¡ç†ç­‰æ ¸å¿ƒå·¥ä½œæµã€‚

### 1.2 æ ¸å¿ƒåœºæ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·å·¥ä½œæµ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. é£ä¹¦ç§èŠ/ç¾¤èŠ â†’ @æœºå™¨äººå‘é€å¯¹è¯å†…å®¹                           â”‚
â”‚                                                                  â”‚
â”‚  2. AI åˆ†æ â†’ æå–è”ç³»äººã€äº‹å®ã€å¾…åŠ                              â”‚
â”‚                                                                  â”‚
â”‚  3. å¡ç‰‡å±•ç¤º â†’ ç”¨æˆ·ç¡®è®¤/ä¿®æ­£                                      â”‚
â”‚                                                                  â”‚
â”‚  4. ä¿å­˜ â†’ friendsAI æ•°æ®åº“ + é£ä¹¦å¤šç»´è¡¨æ ¼                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æ¨¡å—è¾¹ç•Œ

| è¾¹ç•Œ | åŒ…å« | ä¸åŒ…å« |
|------|------|--------|
| **åŠŸèƒ½** | æœºå™¨äººå¯¹è¯ã€å¡ç‰‡äº¤äº’ã€å¤šç»´è¡¨æ ¼åŒæ­¥ | é£ä¹¦æ–‡æ¡£ã€æ—¥å†ã€å®¡æ‰¹ |
| **æ•°æ®** | Contact/ContactFact/ContactTodo åŒå‘åŒæ­¥ | ä¼ä¸šå…¨é‡æ•°æ®ï¼ˆéœ€ä¼ä¸šé›†æˆç‰ˆï¼‰ |
| **ç”¨æˆ·** | ç¬¬ä¸‰æ–¹åº”ç”¨å•†åº—ç”¨æˆ· | ä¼ä¸šç®¡ç†å‘˜é…ç½® |

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              é£ä¹¦å¹³å°                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   é£ä¹¦å®¢æˆ·ç«¯      â”‚                    â”‚      å¤šç»´è¡¨æ ¼            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  ç§èŠçª—å£   â”‚  â”‚                    â”‚  â”‚  è”ç³»äººè¡¨         â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  ç¾¤èŠ @    â”‚  â”‚                    â”‚  â”‚  äº‹å®è¡¨           â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  å¡ç‰‡æ¶ˆæ¯   â”‚  â”‚                    â”‚  â”‚  å¾…åŠè¡¨           â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                      â”‚
            â”‚ Webhook äº‹ä»¶                          â”‚ OAuth 2.0 API
            â”‚                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          friendsAI åç«¯ (NestJS)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         feishu.module                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚webhook.ctrl  â”‚  â”‚card.service  â”‚  â”‚bitable-sync.service       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚- äº‹ä»¶æ¥æ”¶     â”‚  â”‚- å¡ç‰‡æ„å»º     â”‚  â”‚- åŒå‘æ•°æ®åŒæ­¥             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚- æ¶ˆæ¯è§£æ     â”‚  â”‚- å¡ç‰‡æ›´æ–°     â”‚  â”‚- å­—æ®µæ˜ å°„                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚feishu.client â”‚  â”‚oauth.service â”‚  â”‚event-processor.service    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚- API è°ƒç”¨     â”‚  â”‚- Token ç®¡ç†   â”‚  â”‚- æ¶ˆæ¯è½¬ AI Prompt         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚- è¯·æ±‚é‡è¯•     â”‚  â”‚- æˆæƒæµç¨‹     â”‚  â”‚- ç»“æœè§£æ                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ç°æœ‰æ¨¡å— (å¤ç”¨)                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚agent.module  â”‚  â”‚contacts.moduleâ”‚  â”‚conversations.module      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚- AI Runtime  â”‚  â”‚- Contact CRUD â”‚  â”‚- Conversation CRUD        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚- å·¥å…·ç¡®è®¤     â”‚  â”‚- äº‹å®/å¾…åŠ    â”‚  â”‚- æ¶ˆæ¯ç®¡ç†                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    æ•°æ®å±‚                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚FeishuConfig  â”‚  â”‚ConnectorTokenâ”‚  â”‚ç°æœ‰å®ä½“ (Contact/Fact/..) â”‚ â”‚  â”‚
â”‚  â”‚  â”‚- è¡¨æ ¼é…ç½®     â”‚  â”‚- OAuth Token  â”‚  â”‚                          â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡å—ä¾èµ–å…³ç³»

```
feishu.module
    â”œâ”€â”€ depends on â†’ agent.module (AI åˆ†æ)
    â”œâ”€â”€ depends on â†’ contacts.module (è”ç³»äººå­˜å‚¨)
    â”œâ”€â”€ depends on â†’ conversations.module (ä¼šè¯å­˜å‚¨)
    â”œâ”€â”€ depends on â†’ connectors.module (OAuth Token ç®¡ç†)
    â””â”€â”€ exposes â†’ WebhookController (é£ä¹¦äº‹ä»¶å…¥å£)
```

---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 FeishuConfig å®ä½“

å­˜å‚¨ç”¨æˆ·çš„å¤šç»´è¡¨æ ¼é…ç½®æ˜ å°„ã€‚

```typescript
@Entity({ name: 'feishu_configs' })
export class FeishuConfig {
  @PrimaryGeneratedColumn('uuid', { uuidVersion: '7' })
  id: string;

  @Column({ type: 'uuid' })
  userId: string;

  // é£ä¹¦åº”ç”¨é…ç½®
  @Column({ nullable: true })
  bitableAppToken: string;      // é£ä¹¦å¤šç»´è¡¨æ ¼åº”ç”¨ token

  // è¡¨æ ¼ ID æ˜ å°„
  @Column({ nullable: true })
  contactsTableId: string;      // è”ç³»äººè¡¨ ID

  @Column({ nullable: true })
  factsTableId: string;         // äº‹å®è¡¨ ID

  @Column({ nullable: true })
  todosTableId: string;         // å¾…åŠè¡¨ ID

  @Column({ nullable: true })
  conversationsTableId: string; // ä¼šè¯è¡¨ ID (å¯é€‰)

  // åŒæ­¥é…ç½®
  @Column({ default: true })
  syncEnabled: boolean;         // æ˜¯å¦å¯ç”¨è‡ªåŠ¨åŒæ­¥

  @Column({ default: 'auto' })
  syncMode: 'auto' | 'manual' | 'disabled';  // åŒæ­¥æ¨¡å¼

  @Column({ nullable: true, type: 'bigint', transformer: timestampMsTransformer })
  lastSyncedAt: Date;           // æœ€ååŒæ­¥æ—¶é—´

  // å­—æ®µæ˜ å°„é…ç½® (çµæ´»æ˜ å°„ç”¨æˆ·è‡ªå®šä¹‰å­—æ®µ)
  @Column({ type: 'jsonb', nullable: true })
  fieldMapping: {
    contacts?: Record<string, string>;  // friendsAI å­—æ®µ â†’ é£ä¹¦å­—æ®µ
    facts?: Record<string, string>;
    todos?: Record<string, string>;
  };

  @Column({ type: 'jsonb', nullable: true })
  metadata: Record<string, any>;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'userId' })
  user: User;

  @Column({ type: 'bigint', transformer: timestampMsTransformer })
  createdAt: Date;

  @Column({ type: 'bigint', transformer: timestampMsTransformer })
  updatedAt: Date;
}
```

### 3.2 æ•°æ®æ˜ å°„å…³ç³»

| friendsAI å®ä½“ | é£ä¹¦å¤šç»´è¡¨æ ¼ | å­—æ®µæ˜ å°„ |
|----------------|--------------|----------|
| **Contact** | è”ç³»äººè¡¨ | |
| â””â”€ id | record_id | å¤–é”®å…³è” |
| â””â”€ name | name | å§“å |
| â””â”€ email | email | é‚®ç®± |
| â””â”€ phone | phone | ç”µè¯ |
| â””â”€ company | company | å…¬å¸ |
| â””â”€ position | position | èŒä½ |
| â””â”€ tags | tags | å¤šé€‰æ ‡ç­¾ |
| â””â”€ note | notes | å¤‡æ³¨ |
| **ContactFact** | äº‹å®è¡¨ | |
| â””â”€ content | content | äº‹å®å†…å®¹ |
| â””â”€ sourceConversationId | source_conversation | æ¥æºä¼šè¯ |
| â””â”€ createdAt | extracted_at | æå–æ—¶é—´ |
| **ContactTodo** | å¾…åŠè¡¨ | |
| â””â”€ content | task | ä»»åŠ¡å†…å®¹ |
| â””â”€ status | status | çŠ¶æ€ |
| â””â”€ dueAt | due_date | æˆªæ­¢æ—¥æœŸ |
| **Conversation** | ä¼šè¯è¡¨ | |
| â””â”€ title | title | æ ‡é¢˜ |
| â””â”€ content | content | å†…å®¹ |
| â””â”€ summary | summary | æ‘˜è¦ |

---

## 4. API è®¾è®¡

### 4.1 Webhook å…¥å£

#### POST /feishu/webhook

æ¥æ”¶é£ä¹¦äº‹ä»¶æ¨é€ã€‚

```typescript
// è¯·æ±‚ä½“ (é£ä¹¦äº‹ä»¶)
interface FeishuWebhookEvent {
  token: string;              // éªŒè¯ä»¤ç‰Œ
  challenge?: string;         // URL éªŒè¯æ—¶è¿”å›
  type: 'url_verification' | 'event_callback';
  timestamp: string;
  event?: {
    operator_id: string;      // æ“ä½œäºº open_id
    app_id: string;
    type: string;             // äº‹ä»¶ç±»å‹
    // æ¶ˆæ¯äº‹ä»¶
    message?: {
      chat_id: string;
      chat_type: 'private' | 'group';
      content: string;        // JSON æ¶ˆæ¯å†…å®¹
      message_id: string;
      sender_id: string;
    };
    // å¡ç‰‡äº‹ä»¶
    action?: {
      value: Record<string, any>;
      token: string;
    };
  };
}

// å“åº” (URL éªŒè¯)
interface WebhookVerificationResponse {
  challenge: string;
}

// å“åº” (äº‹ä»¶ç¡®è®¤)
interface WebhookAckResponse {
  code: 0;
  msg: 'success';
}
```

### 4.2 å¤šç»´è¡¨æ ¼åŒæ­¥ API

#### POST /feishu/bitable/sync/:type

æ‰‹åŠ¨è§¦å‘åŒæ­¥åˆ°é£ä¹¦è¡¨æ ¼ã€‚

```typescript
// è·¯å¾„å‚æ•°
type SyncType = 'contact' | 'fact' | 'todo' | 'all';

// è¯·æ±‚ä½“
interface BitableSyncRequest {
  entityId?: string;          // å¯é€‰ï¼šæŒ‡å®šåŒæ­¥æŸä¸ªå®ä½“
  force?: boolean;             // æ˜¯å¦å¼ºåˆ¶è¦†ç›–
}

// å“åº”
interface BitableSyncResponse {
  success: boolean;
  synced: number;
  failed: number;
  errors?: Array<{
    entity: string;
    error: string;
  }>;
}
```

#### GET /feishu/bitable/config

è·å–/è®¾ç½®å¤šç»´è¡¨æ ¼é…ç½®ã€‚

```typescript
// å“åº”
interface BitableConfigResponse {
  configured: boolean;
  config?: {
    bitableAppToken: string;
    contactsTableId?: string;
    factsTableId?: string;
    todosTableId?: string;
    syncEnabled: boolean;
    syncMode: 'auto' | 'manual' | 'disabled';
    lastSyncedAt?: string;
  };
}
```

#### POST /feishu/bitable/config

è®¾ç½®å¤šç»´è¡¨æ ¼é…ç½®ã€‚

```typescript
// è¯·æ±‚ä½“
interface BitableConfigUpdateRequest {
  bitableAppToken: string;
  contactsTableId?: string;
  factsTableId?: string;
  todosTableId?: string;
  syncEnabled?: boolean;
  syncMode?: 'auto' | 'manual' | 'disabled';
  fieldMapping?: {
    contacts?: Record<string, string>;
    facts?: Record<string, string>;
    todos?: Record<string, string>;
  };
}
```

### 4.3 OAuth ç›¸å…³ API

æ‰©å±•ç°æœ‰ `connectors` æ¨¡å—ï¼š

#### POST /connectors/feishu/token

å®ç° OAuth token äº¤æ¢ï¼ˆç›®å‰æ˜¯å ä½ï¼‰ã€‚

```typescript
// è¯·æ±‚ä½“
interface FeishuTokenExchangeRequest {
  code: string;
  redirectUri: string;
}

// å“åº”
interface FeishuTokenExchangeResponse {
  success: boolean;
  accessToken?: string;
  refreshToken?: string;
  expiresAt?: string;
  error?: string;
}
```

---

## 5. äº¤äº’æµç¨‹è®¾è®¡

### 5.1 æœºå™¨äººå¯¹è¯åˆ†ææµç¨‹

```
ç”¨æˆ·                           friendsAI åç«¯                    AI Agent
 â”‚                                  â”‚                              â”‚
 â”‚ @æœºå™¨äºº "ä»Šå¤©å’Œå¼ ä¸‰èŠäº†..."      â”‚                              â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
 â”‚                                  â”‚ 1. è§£ææ¶ˆæ¯                   â”‚
 â”‚                                  â”‚ 2. æ„å»º AI Prompt            â”‚
 â”‚                                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚                                  â”‚                              â”‚ 3. AI åˆ†æ
 â”‚                                  â”‚                              â”‚ - æå–è”ç³»äºº
 â”‚                                  â”‚                              â”‚ - æå–äº‹å®
 â”‚                                  â”‚                              â”‚ - ç”Ÿæˆå¾…åŠ
 â”‚                                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                                  â”‚ 4. åˆ†æç»“æœ                   â”‚
 â”‚ å¡ç‰‡æ¶ˆæ¯ (åˆ†æç»“æœ)              â”‚                              â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                              â”‚
 â”‚ â”‚ ğŸ“Š è”ç³»äººï¼šå¼ ä¸‰              â”‚   â”‚                              â”‚
 â”‚ â”‚ ğŸ¢ å…¬å¸ï¼šABCç§‘æŠ€             â”‚   â”‚                              â”‚
 â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚                              â”‚
 â”‚ â”‚ ğŸ“ äº‹å®ï¼š                   â”‚   â”‚                              â”‚
 â”‚ â”‚ â€¢ ä¸»å¯¼è¿‡äº‘å¹³å°è¿ç§»é¡¹ç›®       â”‚   â”‚                              â”‚
 â”‚ â”‚ â€¢ å…³æ³¨ Serverless æŠ€æœ¯      â”‚   â”‚                              â”‚
 â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚                              â”‚
 â”‚ â”‚ âœ… å¾…åŠï¼š                   â”‚   â”‚                              â”‚
 â”‚ â”‚ â€¢ [ ] å‘é€äº§å“èµ„æ–™           â”‚   â”‚                              â”‚
 â”‚ â”‚ â€¢ [ ] å®‰æ’æŠ€æœ¯å¯¹æ¥ä¼šè®®       â”‚   â”‚                              â”‚
 â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚                              â”‚
 â”‚ â”‚ [ä¿å­˜] [åŒæ­¥é£ä¹¦è¡¨æ ¼]       â”‚   â”‚                              â”‚
 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                              â”‚
 â”‚                                  â”‚                              â”‚
 â”‚ ç‚¹å‡» [ä¿å­˜] æŒ‰é’®                  â”‚                              â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
 â”‚                                  â”‚ 5. ä¿å­˜åˆ°æ•°æ®åº“               â”‚
 â”‚                                  â”‚ 6. (å¯é€‰) åŒæ­¥åˆ°é£ä¹¦è¡¨æ ¼       â”‚
 â”‚                                  â”‚                              â”‚
 â”‚ âœ… "å·²ä¿å­˜åˆ°è”ç³»äººåº“"             â”‚                              â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
```

### 5.2 å¡ç‰‡äº¤äº’å¤„ç†æµç¨‹

```typescript
// å¡ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
interface CardActionEvent {
  token: string;              // å¡ç‰‡ token
  action: {
    value: {
      action: 'save' | 'sync_bitable' | 'save_and_sync';
      data: {
        contactName: string;
        facts: string[];
        todos: string[];
      };
    };
  };
}

// å¤„ç†æµç¨‹
async handleCardAction(event: CardActionEvent) {
  const { action, data } = event.action.value;

  switch (action) {
    case 'save':
      // ä¿å­˜åˆ° friendsAI æ•°æ®åº“
      await saveToDatabase(data);
      return updateCard('âœ… å·²ä¿å­˜');

    case 'sync_bitable':
      // åŒæ­¥åˆ°é£ä¹¦è¡¨æ ¼
      await syncToBitable(data);
      return updateCard('âœ… å·²åŒæ­¥åˆ°é£ä¹¦è¡¨æ ¼');

    case 'save_and_sync':
      // ä¿å­˜ + åŒæ­¥
      await saveToDatabase(data);
      await syncToBitable(data);
      return updateCard('âœ… å·²ä¿å­˜å¹¶åŒæ­¥');
  }
}
```

### 5.3 å¤šç»´è¡¨æ ¼åŒå‘åŒæ­¥æµç¨‹

```
friendsAI                          é£ä¹¦å¤šç»´è¡¨æ ¼
    â”‚                                     â”‚
    â”‚ 1. AI åˆ†æå®Œæˆï¼Œç”Ÿæˆ Contact/Fact   â”‚
    â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ 2. å†™å…¥è®°å½•
    â”‚                                     â”‚    POST /records
    â”‚                                     â”‚
    â”‚ 3. ç”¨æˆ·åœ¨é£ä¹¦è¡¨æ ¼ä¸­ä¿®æ”¹             â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 4. æ•°æ®å˜æ›´äº‹ä»¶
    â”‚                                     â”‚
    â”‚ 5. åŒæ­¥å˜æ›´åˆ° friendsAI              â”‚
    â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ 6. æ›´æ–°è®°å½•
    â”‚    PATCH /records/{id}              â”‚
```

---

## 6. å¡ç‰‡æ¶ˆæ¯è®¾è®¡

### 6.1 è”ç³»äººåˆ†æå¡ç‰‡

```typescript
interface ContactAnalysisCard {
  config: {
    wide_screen_mode: true;
  };
  header: {
    title: {
      content: 'ğŸ“Š è”ç³»äººåˆ†æç»“æœ';
      tag: 'plain_text';
    };
  };
  elements: Array<
    | TextElement
    | DividerElement
    | ActionElement
  >;
}

// å®é™… JSON ç¤ºä¾‹
const cardJson = {
  config: { wide_screen_mode: true },
  header: {
    title: { content: 'ğŸ“Š è”ç³»äººåˆ†æç»“æœ', tag: 'plain_text' }
  },
  elements: [
    // è”ç³»äººåŸºæœ¬ä¿¡æ¯
    {
      tag: 'div',
      fields: [
        {
          is_short: true,
          text: { tag: 'lark_md', content: '**å§“å**: å¼ ä¸‰' }
        },
        {
          is_short: true,
          text: { tag: 'lark_md', content: '**å…¬å¸**: ABCç§‘æŠ€' }
        },
        {
          is_short: true,
          text: { tag: 'lark_md', content: '**èŒä½**: æŠ€æœ¯æ€»ç›‘' }
        },
        {
          is_short: true,
          text: { tag: 'lark_md', content: '**é‚®ç®±**: zhangsan@example.com' }
        }
      ]
    },
    // åˆ†å‰²çº¿
    { tag: 'hr' },
    // æå–çš„äº‹å®
    {
      tag: 'div',
      text: {
        tag: 'lark_md',
        content: '**ğŸ“ æå–çš„äº‹å®**\nâ€¢ æ›¾åœ¨2024å¹´Q1ä¸»å¯¼è¿‡äº‘å¹³å°è¿ç§»é¡¹ç›®\nâ€¢ å…³æ³¨ Serverless å’Œ AI Agent æŠ€æœ¯æ ˆ\nâ€¢ ç›®å‰æ­£åœ¨è¯„ä¼°æ–°çš„ CRM ç³»ç»Ÿ'
      }
    },
    // åˆ†å‰²çº¿
    { tag: 'hr' },
    // å»ºè®®çš„å¾…åŠ
    {
      tag: 'div',
      text: {
        tag: 'lark_md',
        content: '**âœ… å»ºè®®å¾…åŠ**\nâ€¢ [ ] ä¸‹å‘¨ä¸‰å‰å‘é€äº§å“èµ„æ–™\nâ€¢ [ ] å®‰æ’æŠ€æœ¯å›¢é˜Ÿå¯¹æ¥ä¼šè®®\nâ€¢ [ ] å‡†å¤‡ CRM æ–¹æ¡ˆæ¼”ç¤º'
      }
    },
    // æ“ä½œæŒ‰é’®
    {
      tag: 'action',
      actions: [
        {
          tag: 'button',
          text: { tag: 'plain_text', content: 'ä¿å­˜åˆ°è”ç³»äººåº“' },
          type: 'primary',
          value: {
            action: 'save',
            data: { /* åˆ†æç»“æœæ•°æ® */ }
          }
        },
        {
          tag: 'button',
          text: { tag: 'plain_text', content: 'åŒæ­¥åˆ°é£ä¹¦è¡¨æ ¼' },
          value: {
            action: 'sync_bitable',
            data: { /* åˆ†æç»“æœæ•°æ® */ }
          }
        },
        {
          tag: 'button',
          text: { tag: 'plain_text', content: 'ä¿å­˜å¹¶åŒæ­¥' },
          type: 'primary',
          value: {
            action: 'save_and_sync',
            data: { /* åˆ†æç»“æœæ•°æ® */ }
          }
        }
      ]
    }
  ]
};
```

### 6.2 åŒæ­¥çŠ¶æ€å¡ç‰‡

```typescript
const syncStatusCard = {
  config: { wide_screen_mode: true },
  header: {
    title: { content: 'ğŸ”„ åŒæ­¥çŠ¶æ€', tag: 'plain_text' }
  },
  elements: [
    {
      tag: 'div',
      text: {
        tag: 'lark_md',
        content: '**åŒæ­¥æ—¶é—´**: 2026-02-10 14:30\n**åŒæ­¥æ•°é‡**: 3 æ¡è”ç³»äººï¼Œ5 æ¡äº‹å®ï¼Œ2 æ¡å¾…åŠ'
      }
    },
    {
      tag: 'hr'
    },
    {
      tag: 'div',
      text: {
        tag: 'lark_md',
        content: '**åŒæ­¥è¯¦æƒ…**:\nâœ… è”ç³»äºº "å¼ ä¸‰" - å·²åŒæ­¥\nâœ… è”ç³»äºº "æå››" - å·²åŒæ­¥\nâš ï¸ è”ç³»äºº "ç‹äº”" - å­—æ®µç¼ºå¤±ï¼Œè·³è¿‡'
      }
    }
  ]
};
```

---

## 7. æœåŠ¡è®¾è®¡

### 7.1 æ¨¡å—ç»“æ„

```
packages/server-nestjs/src/feishu/
â”œâ”€â”€ feishu.module.ts
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ webhook.controller.ts        # é£ä¹¦äº‹ä»¶ Webhook
â”‚   â””â”€â”€ bitable.controller.ts        # å¤šç»´è¡¨æ ¼æ“ä½œ API
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ webhook.service.ts           # äº‹ä»¶å¤„ç†
â”‚   â”œâ”€â”€ card.service.ts              # å¡ç‰‡æ„å»º/æ›´æ–°
â”‚   â”œâ”€â”€ bitable-sync.service.ts      # å¤šç»´è¡¨æ ¼åŒæ­¥
â”‚   â”œâ”€â”€ message.service.ts           # æ¶ˆæ¯å‘é€
â”‚   â””â”€â”€ feishu-api.service.ts        # é£ä¹¦ API å®¢æˆ·ç«¯
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ webhook-event.dto.ts
â”‚   â”œâ”€â”€ card.dto.ts
â”‚   â””â”€â”€ bitable-sync.dto.ts
â”œâ”€â”€ types/
â”‚   â””â”€â”€ feishu.types.ts
â””â”€â”€ constants/
    â””â”€â”€ feishu.constants.ts
```

### 7.2 æ ¸å¿ƒæœåŠ¡æ¥å£

#### WebhookService

```typescript
@Injectable()
export class WebhookService {
  constructor(
    private cardService: CardService,
    private eventProcessorService: EventProcessorService,
  ) {}

  // å¤„ç† Webhook äº‹ä»¶
  async handleEvent(event: FeishuWebhookEvent): Promise<void> {
    if (event.type === 'url_verification') {
      return this.handleVerification(event);
    }

    if (event.type === 'event_callback') {
      return this.handleCallback(event);
    }
  }

  // URL éªŒè¯
  private async handleVerification(event: FeishuWebhookEvent): Promise<void> {
    // è¿”å› challenge
  }

  // äº‹ä»¶å›è°ƒå¤„ç†
  private async handleCallback(event: FeishuWebhookEvent): Promise<void> {
    switch (event.event?.type) {
      case 'im.message.receive_v1':
        await this.handleMessage(event.event);
        break;
      case 'card.action.trigger':
        await this.handleCardAction(event.event);
        break;
    }
  }

  // å¤„ç†æ¶ˆæ¯
  private async handleMessage(event: FeishuEvent): Promise<void> {
    // 1. è§£ææ¶ˆæ¯å†…å®¹
    // 2. è°ƒç”¨ AI åˆ†æ
    // 3. å‘é€å¡ç‰‡å›å¤
  }

  // å¤„ç†å¡ç‰‡æ“ä½œ
  private async handleCardAction(event: FeishuEvent): Promise<void> {
    // 1. è§£ææ“ä½œç±»å‹
    // 2. æ‰§è¡Œç›¸åº”æ“ä½œ
    // 3. æ›´æ–°å¡ç‰‡çŠ¶æ€
  }
}
```

#### BitableSyncService

```typescript
@Injectable()
export class BitableSyncService {
  constructor(
    @InjectRepository(FeishuConfig)
    private feishuConfigRepo: Repository<FeishuConfig>,
    private feishuApiService: FeishuApiService,
  ) {}

  // åŒæ­¥è”ç³»äººåˆ°é£ä¹¦è¡¨æ ¼
  async syncContact(userId: string, contactId: string): Promise<void> {
    const config = await this.getConfig(userId);
    const contact = await this.getContact(contactId);

    const record = this.mapContactToRecord(contact);
    await this.feishuApiService.createRecord(
      config.bitableAppToken,
      config.contactsTableId,
      record,
    );
  }

  // ä»é£ä¹¦è¡¨æ ¼åŒæ­¥è”ç³»äºº
  async syncContactFromBitable(userId: string): Promise<void> {
    const config = await this.getConfig(userId);
    const records = await this.feishuApiService.getRecords(
      config.bitableAppToken,
      config.contactsTableId,
    );

    for (const record of records) {
      const contact = this.mapRecordToContact(record);
      await this.saveContact(contact);
    }
  }

  // æ‰¹é‡åŒæ­¥
  async syncAll(userId: string, type: SyncType): Promise<BitableSyncResponse> {
    // å®ç°æ‰¹é‡åŒæ­¥é€»è¾‘
  }

  // å­—æ®µæ˜ å°„
  private mapContactToRecord(contact: Contact): Record<string, any> {
    const config = await this.getConfig(contact.userId);
    const mapping = config.fieldMapping?.contacts || {};

    const record: Record<string, any> = {};

    // ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰æ˜ å°„æˆ–é»˜è®¤æ˜ å°„
    for (const [sourceField, targetField] of Object.entries(mapping)) {
      record[targetField] = contact[sourceField];
    }

    return record;
  }
}
```

#### CardService

```typescript
@Injectable()
export class CardService {
  // æ„å»ºè”ç³»äººåˆ†æå¡ç‰‡
  buildContactAnalysisCard(data: ContactAnalysisData): string {
    return JSON.stringify({
      config: { wide_screen_mode: true },
      header: { title: { content: 'ğŸ“Š è”ç³»äººåˆ†æç»“æœ', tag: 'plain_text' } },
      elements: [
        // ... å¡ç‰‡å…ƒç´ 
      ],
    });
  }

  // æ„å»ºåŒæ­¥çŠ¶æ€å¡ç‰‡
  buildSyncStatusCard(data: SyncStatusData): string {
    // ...
  }

  // æ›´æ–°å¡ç‰‡
  async updateCard(cardToken: string, newCard: string): Promise<void> {
    // è°ƒç”¨é£ä¹¦ API æ›´æ–°å¡ç‰‡
  }
}
```

#### FeishuApiService

```typescript
@Injectable()
export class FeishuApiService {
  private baseUrl = 'https://open.feishu.cn/open-apis';

  constructor(
    private configService: ConfigService,
    private httpService: HttpService,
  ) {}

  // è·å– tenant_access_token
  async getTenantAccessToken(): Promise<string> {
    // ç¼“å­˜ token
  }

  // å‘é€æ¶ˆæ¯
  async sendMessage(chatId: string, msgType: string, content: any): Promise<void> {
    const token = await this.getTenantAccessToken();
    // ...
  }

  // æ›´æ–°å¡ç‰‡
  async updateCard(token: string, card: string): Promise<void> {
    // ...
  }

  // åˆ›å»ºè®°å½•
  async createRecord(appToken: string, tableId: string, record: any): Promise<void> {
    // ...
  }

  // è·å–è®°å½•
  async getRecords(appToken: string, tableId: string): Promise<any[]> {
    // ...
  }

  // æ›´æ–°è®°å½•
  async updateRecord(appToken: string, tableId: string, recordId: string, record: any): Promise<void> {
    // ...
  }
}
```

---

## 8. ç¯å¢ƒå˜é‡é…ç½®

```env
# é£ä¹¦åº”ç”¨é…ç½®
FEISHU_APP_ID=cli_xxxxxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxxxxxxxxxx
FEISHU_ENCRYPT_KEY=your_verification_token_encryption_key
FEISHU_VERIFICATION_TOKEN=your_verification_token

# OAuth é…ç½®
FEISHU_OAUTH_AUTHORIZE_URL=https://open.feishu.cn/open-apis/authen/v1/authorize
FEISHU_OAUTH_TOKEN_URL=https://open.feishu.cn/open-apis/authen/v3/tenant_access_token/internal
FEISHU_OAUTH_REDIRECT_URI=https://your-domain.com/connectors/feishu/callback
FEISHU_OAUTH_SCOPE=contact:user.base:readonly,bitable:app:readonly

# API é…ç½®
FEISHU_API_BASE_URL=https://open.feishu.cn/open-apis
FEISHU_BITABLE_API_URL=https://open.feishu.cn/open-apis/bitable/v1

# åŠŸèƒ½å¼€å…³
FEISHU_BOT_ENABLED=true
FEISHU_BITABLE_SYNC_ENABLED=true
FEISHU_AUTO_SYNC_ON_ANALYSIS=true
```

---

## 9. é”™è¯¯å¤„ç†

### 9.1 é”™è¯¯ç±»å‹

| é”™è¯¯ç±»å‹ | åœºæ™¯ | å¤„ç†ç­–ç•¥ |
|----------|------|----------|
| `FEISHU_AUTH_FAILED` | Token è¿‡æœŸ/æ— æ•ˆ | åˆ·æ–° Tokenï¼Œé‡è¯• |
| `FEISHU_RATE_LIMIT` | API è°ƒç”¨è¶…é™ | æŒ‡æ•°é€€é¿é‡è¯• |
| `FEISHU_PERMISSION_DENIED` | æƒé™ä¸è¶³ | æç¤ºç”¨æˆ·é‡æ–°æˆæƒ |
| `FEISHU_TABLE_NOT_FOUND` | è¡¨æ ¼ä¸å­˜åœ¨ | æç¤ºç”¨æˆ·é…ç½®è¡¨æ ¼ |
| `FEISHU_INVALID_WEBHOOK` | Webhook éªŒè¯å¤±è´¥ | è®°å½•æ—¥å¿—ï¼Œæ‹’ç»è¯·æ±‚ |

### 9.2 é‡è¯•ç­–ç•¥

```typescript
interface RetryConfig {
  maxRetries: number;
  initialDelay: number;
  maxDelay: number;
  backoffMultiplier: number;
}

const feishuRetryConfig: RetryConfig = {
  maxRetries: 3,
  initialDelay: 1000,
  maxDelay: 10000,
  backoffMultiplier: 2,
};
```

---

## 10. å®‰å…¨è€ƒè™‘

### 10.1 Webhook éªŒè¯

```typescript
async verifyWebhook(event: FeishuWebhookEvent): Promise<boolean> {
  // 1. éªŒè¯ token
  const expectedToken = this.configService.get('FEISHU_VERIFICATION_TOKEN');
  if (event.token !== expectedToken) {
    return false;
  }

  // 2. éªŒè¯æ—¶é—´æˆ³ (é˜²é‡æ”¾)
  const eventTime = parseInt(event.timestamp);
  const now = Math.floor(Date.now() / 1000);
  if (Math.abs(now - eventTime) > 300) { // 5 åˆ†é’Ÿ
    return false;
  }

  return true;
}
```

### 10.2 æ•°æ®éš”ç¦»

- æ‰€æœ‰æ“ä½œåŸºäº `userId` éš”ç¦»
- å¤šç»´è¡¨æ ¼é…ç½®æŒ‰ç”¨æˆ·å­˜å‚¨
- åŒæ­¥æ“ä½œä»…å¤„ç†ç”¨æˆ·æˆæƒçš„æ•°æ®

### 10.3 Token å®‰å…¨

- Access Token åŠ å¯†å­˜å‚¨
- Refresh Token ä»…ç”¨äºåˆ·æ–°ï¼Œä¸æš´éœ²ç»™å‰ç«¯
- Token è¿‡æœŸè‡ªåŠ¨åˆ·æ–°

---

## 11. æµ‹è¯•è®¡åˆ’

### 11.1 å•å…ƒæµ‹è¯•

- WebhookService äº‹ä»¶å¤„ç†
- CardService å¡ç‰‡æ„å»º
- BitableSyncService æ•°æ®æ˜ å°„

### 11.2 é›†æˆæµ‹è¯•

- é£ä¹¦ API Mock æœåŠ¡
- ç«¯åˆ°ç«¯åŒæ­¥æµç¨‹

### 11.3 æ‰‹åŠ¨æµ‹è¯•

| åœºæ™¯ | æ­¥éª¤ | é¢„æœŸç»“æœ |
|------|------|----------|
| æœºå™¨äººå¯¹è¯ | @æœºå™¨äººå‘é€æ¶ˆæ¯ | è¿”å›åˆ†æå¡ç‰‡ |
| ä¿å­˜è”ç³»äºº | ç‚¹å‡»ä¿å­˜æŒ‰é’® | ä¿å­˜æˆåŠŸï¼Œå¡ç‰‡æ›´æ–° |
| åŒæ­¥è¡¨æ ¼ | ç‚¹å‡»åŒæ­¥æŒ‰é’® | æ•°æ®å†™å…¥é£ä¹¦è¡¨æ ¼ |
| Token è¿‡æœŸ | ä½¿ç”¨è¿‡æœŸ Token | è‡ªåŠ¨åˆ·æ–°ï¼Œé‡è¯•æˆåŠŸ |

---

## 12. å®æ–½é‡Œç¨‹ç¢‘

### Phase 1: åŸºç¡€æ­å»º (1-2 å¤©)

- [ ] feishu.module æ­å»º
- [ ] WebhookController å®ç°
- [ ] Webhook éªŒè¯é€»è¾‘
- [ ] FeishuConfig å®ä½“ä¸è¿ç§»

### Phase 2: æœºå™¨äººå¯¹è¯ (2-3 å¤©)

- [ ] æ¶ˆæ¯äº‹ä»¶å¤„ç†
- [ ] AI åˆ†æé›†æˆ
- [ ] å¡ç‰‡æ¶ˆæ¯æ„å»º
- [ ] å¡ç‰‡äº¤äº’å¤„ç†

### Phase 3: å¤šç»´è¡¨æ ¼åŒæ­¥ (2-3 å¤©)

- [ ] é£ä¹¦ API å®¢æˆ·ç«¯
- [ ] æ•°æ®æ˜ å°„é€»è¾‘
- [ ] åŒå‘åŒæ­¥æœåŠ¡
- [ ] åŒæ­¥é…ç½®ç®¡ç†

### Phase 4: å‰ç«¯é›†æˆ (1-2 å¤©)

- [ ] OAuth æˆæƒå¼•å¯¼
- [ ] è¡¨æ ¼é…ç½®é¡µé¢
- [ ] åŒæ­¥çŠ¶æ€å±•ç¤º

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
*æœ€åæ›´æ–°: 2026-02-10*

schema: spec-driven

context: |
  Product: FriendsAI（AI 原生人脉/关系情报管理；Conversation-first；聊天内完成归档/简报/工具执行）

  Monorepo: Bun workspaces
    - packages/client：Taro 前端（当前主要运行 H5）
    - packages/server-nestjs：NestJS 后端主线（新主线，直接切换）
    - packages/server：Express 旧主线（仅保留用于回滚对照；默认不再新增功能）

  Tech stack (client): Taro 3.6 + React 18 + TypeScript
  UI (client): taro-ui + 自定义组件（SCSS）
  Tech stack (server mainline): NestJS 11 + TypeORM + TypeScript（Node.js >= 18）
  Storage (new mainline): PostgreSQL + pgvector（dev 端口 5434；使用全新 DB；旧 DB 保留）

  Runtime conventions (target):
    - API prefix: /v1（NestJS 设置 global prefix；所有 HTTP/SSE 端点均在 /v1 下）
    - H5-first: 优先保证 H5 可用；流式优先 SSE（EventSource 有 GET/无自定义 header 限制；fetch stream/WS 也可，但需在 design 明确）
    - Auth: JWT accessToken/refreshToken；前端使用 Taro storage（建议 key: token / refreshToken）
    - Data scoping: 默认按 userId 隔离数据（不引入 workspace/multi-tenant，除非需求明确）
    - DB: 新主线使用全新数据库（例如 friendsai_v2）；旧库保留用于回滚/对照（不要在新主线写入旧库）

  High-level contract (target, per designs/tech_design.md):
    - Conversation-first：会话(conversation)+多消息(message) 是第一公民
    - SSE：流式聊天/工具 trace（message events + tool trace + A2UI + citations）
    - Archive：会话归档提取 → 用户确认 → 写入 contacts/events/facts/todos
    - Tool confirmation：写/发类工具必须 requires_confirmation

  Repo layout (main paths):
    - packages/client/src/pages/...
    - packages/client/src/components/...
    - packages/client/src/services/...
    - packages/client/src/hooks/...
    - packages/server-nestjs/src/(agent|ai|auth|contacts|conversations|tool-confirmations|connectors|entities)/...

  Constraints:
    - 不引入新的跨端框架（继续使用 Taro）
    - 新主线以 packages/server-nestjs 为准；除非明确，不要在 packages/server(Express) 上继续扩展
    - 允许前后端契约重写（激进模式）；但每次变更必须给出可跑通的验收路径/命令
    - 使用全新 DB；不做旧数据迁移（旧库仅保留回滚用）

rules:
  proposal:
    - 正文中文；保留英文技术标识：API/字段/错误码/路径/命令/Requirement IDs。
    - 所有输出以“可验收”为第一优先，避免空话。
    - 必须包含：Intent / Scope / Non-Goals / Risks / Rollback / Acceptance。
    - Acceptance 必须可验证（命令或可观察检查点）。

  specs:
    - 正文中文；保留英文技术标识：API/字段/错误码/路径/命令/Requirement IDs。
    - 所有输出以“可验收”为第一优先，避免空话。
    - Delta 必须用 ADDED/MODIFIED/REMOVED（英文关键字）。
    - 每条 Requirement 必须有稳定 ID（如 AUTH-010）+ 至少 1 个 Given/When/Then（英文关键字）。
    - 只写行为合同，不写实现细节。
    - 先引用现有模式，再发明新模式。

  design:
    - 正文中文；保留英文技术标识：API/字段/错误码/路径/命令/Requirement IDs。
    - 所有输出以“可验收”为第一优先，避免空话。
    - 必须覆盖：Contracts（API/数据结构）/ Edge Cases / Security / Rollout-Rollback。
    - 写清兼容策略（保持不变/变化点/避免破坏方式）。

  tasks:
    - 正文中文；保留英文技术标识：API/字段/错误码/路径/命令/Requirement IDs。
    - 所有输出以“可验收”为第一优先，避免空话。
    - 每条任务映射 Requirement ID；每条任务都有 Done When（可验证）。
    - 任务必须 PR-sized + 单目标；优先先契约后实现以降低冲突。



# Project context (optional)
# This is shown to AI when creating artifacts.
# Add your tech stack, conventions, style guides, domain knowledge, etc.
# Example:
#   context: |
#     Tech stack: TypeScript, React, Node.js
#     We use conventional commits
#     Domain: e-commerce platform

# Per-artifact rules (optional)
# Add custom rules for specific artifacts.
# Example:
#   rules:
#     proposal:
#       - Keep proposals under 500 words
#       - Always include a "Non-goals" section
#     tasks:
#       - Break tasks into chunks of max 2 hours

# rules:
#   proposal: |
#     ## Language & format
#     - 正文使用中文（解释、意图、取舍、风险、备注）。
#     - 必须保留英文技术标识：API 路径、参数名、字段名、错误码、Requirement IDs（如 AUTH-010）、文件路径、命令行。
#     - 必须包含章节：Intent、Scope、Non-Goals、Risks、Rollback、Acceptance。
#     - Acceptance 必须可验证：给出可执行命令或可观察的检查点（例如响应字段、状态码、日志字段）。

#   specs: |
#     ## Language & format
#     - 需求描述可用中文，但必须保留结构关键字为英文：ADDED / MODIFIED / REMOVED / RENAMED。
#     - 每条 Requirement 必须有稳定 ID（如 AUTH-010），并保持英文 ID 不翻译。
#     - 每条 Requirement 至少 1 个 Scenario，且必须用 Given / When / Then（这三个词必须是英文）。
#     - Scenario 行允许中文叙述，但其中的 API 路径、字段名、错误码必须是英文原样。
#     - 只写“行为合同”，不要写实现细节（例如具体类名、具体函数分解）。

#   design: |
#     ## Language & format
#     - 正文使用中文，但保留英文技术标识（接口/字段/错误码/文件路径/命令）。
#     - 必须包含：Architecture、Data Model/Contracts、Edge Cases、Security、Rollout/Rollback。
#     - 必须说明兼容策略：哪些行为保持不变、哪些会变、如何避免破坏旧接口/旧数据。

#   tasks: |
#     ## Language & format
#     - 任务说明可以中文，但必须保留英文：Requirement IDs、命令、路径、错误码。
#     - 每条任务必须映射至少一个 Requirement ID（如 [AUTH-010]）。
#     - 每条任务必须包含 Done When（可验证）：命令/测试用例/可观察结果。
#     - 任务必须 PR-sized（可独立合并），且单目标（动词 + 对象）。
